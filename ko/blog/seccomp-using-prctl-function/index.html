<!doctype html><html lang=ko><head><meta charset=UTF-8><meta content="default-src 'self';font-src 'self' data:;img-src 'self' https://* data:;media-src 'self';style-src 'self';frame-src player.vimeo.com https://www.youtube-nocookie.com;connect-src 'self';script-src 'self' 'self'" http-equiv=Content-Security-Policy><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://bl4nk.kr name=base><title>~/bl4nk • [SECCOMP] prctl를 이용한 SECCOMP 정리</title><link href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50%" x="50%" dominant-baseline="central" text-anchor="middle" font-size="88">🍑</text></svg>' rel=icon><link title="~/bl4nk - Atom Feed" href=https://bl4nk.kr/atom.xml rel=alternate type=application/atom+xml><link href="https://bl4nk.kr/custom_subset.css?h=0b9535a28bc3d5bf2321" rel=stylesheet><link href="https://bl4nk.kr/main.css?h=b72e51d92aa1469777ff" rel=stylesheet><link href="https://bl4nk.kr/skins/lavender.css?h=31ee0a710ed660d122f6" rel=stylesheet><meta content="light dark" name=color-scheme><meta media="(prefers-color-scheme: light)" content=#ffffff name=theme-color><meta media="(prefers-color-scheme: dark)" content=#000000 name=theme-color><meta content="prctl 사용법부터 관련 도구, 예상 취약점까지" name=description><meta content="prctl 사용법부터 관련 도구, 예상 취약점까지" property=og:description><meta content="[SECCOMP] prctl를 이용한 SECCOMP 정리" property=og:title><meta content=article property=og:type><meta content=en_GB property=og:locale:alternate><link href=https://bl4nk.kr/blog/seccomp-using-prctl-function/ hreflang=en rel=alternate><meta content=ko_KR property=og:locale:alternate><link href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/ hreflang=ko rel=alternate><link href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/ rel=canonical><meta content=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/ property=og:url><meta content=~/bl4nk property=og:site_name><noscript><link href=https://bl4nk.kr/no_js.css rel=stylesheet></noscript><script src=https://bl4nk.kr/js/initializeTheme.min.js></script><script defer src=https://bl4nk.kr/js/themeSwitcher.min.js></script><body class=use-sans-serif><header><nav class=navbar><div class=nav-title><a class=home-title href=https://bl4nk.kr/ko/>~/bl4nk</a></div><div class=nav-navs><ul><li><a class="nav-links no-hover-padding" href=https://bl4nk.kr/ko/about/>about </a><li><a class="nav-links no-hover-padding" href=https://bl4nk.kr/ko/blog/>blog </a><li><a class="nav-links no-hover-padding" href=https://bl4nk.kr/ko/archive/>archive </a><li><a class="nav-links no-hover-padding" href=https://bl4nk.kr/ko/tags/>tags </a><li class=menu-icons-container><ul class=menu-icons-group><li class=language-switcher><details class=dropdown><summary aria-label="언어 선택" title="언어 선택" aria-haspopup=true role=button><div class=language-switcher-icon></div></summary> <div class=dropdown-content role=menu>한국어<a aria-label=English href=https://bl4nk.kr/blog/seccomp-using-prctl-function/ lang=en role=menuitem>English</a></div></details><li class="theme-switcher-wrapper js"><div aria-label="어두운 모드로 전환" title="어두운/밝은 모드로 전환" aria-pressed=false class=theme-switcher role=button tabindex=0></div><div aria-label="모드를 사이트 기본값으로 재설정" class="theme-resetter arrow" title="모드를 사이트 기본값으로 재설정" aria-hidden=true role=button tabindex=0></div></ul></ul></div></nav></header><div class=content><main><article><h1 class=article-title>[SECCOMP] prctl를 이용한 SECCOMP 정리</h1><ul class=meta><li>2024년 6월 15일<li title="992개의 단어"><span aria-hidden=true class=separator>•</span>5분 읽기<li class=tag><span aria-hidden=true class=separator>•</span>Tags: <li class=tag><a href=https://bl4nk.kr/ko/tags/study/>study</a>, <li class=tag><a href=https://bl4nk.kr/ko/tags/linux/>linux</a>, <li class=tag><a href=https://bl4nk.kr/ko/tags/seccomp/>seccomp</a>, <li class=tag><a href=https://bl4nk.kr/ko/tags/mitigation/>mitigation</a></ul><div class=toc-container><h3>목차</h3><ul><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#0x00-introduction>0x00. Introduction</a><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#0x01-prctl-hamsu>0x01. prctl 함수</a> <ul><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#pr-set-no-new-privs>PR_SET_NO_NEW_PRIVS</a><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#pr-set-seccomp>PR_SET_SECCOMP</a> <ul><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#seccomp-mode-strict>SECCOMP_MODE_STRICT</a><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#seccomp-mode-filter>SECCOMP_MODE_FILTER</a></ul></ul><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#0x03-seccomp-tools>0x03 seccomp-tools</a> <ul><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#asm>asm</a><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#disasm>disasm</a><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#dump>dump</a><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#emu>emu</a></ul><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#0x04-expected-vulnerability>0x04. Expected Vulnerability</a> <ul><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#x32-syscall>x32 Syscall</a><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#filter-overwrite>Filter Overwrite</a><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#seccomp-bypass>SECCOMP Bypass</a></ul><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#0x05-camgojaryo>0x05. 참고자료</a></ul></div><section class=body><h2 id=0x00-introduction><a aria-label="Anchor link for: 0x00-introduction" class="header-anchor no-hover-padding" href=#0x00-introduction><span aria-hidden=true class=link-icon></span></a> 0x00. Introduction</h2><p>SECCOMP(SECure COMPuting mode)는 프로세스 샌드박싱을 제공하는 기능이다. 자세하게는 프로세스에서 실행되는 syscall을 제한시켜, 호출 가능한 것 이외의 syscall이 호출될 경우 프로세스를 종료시킨다(<code>SIGKILL</code>). 다른 보호 기법들처럼 컴파일 시 적용하는게 아니라 소스코드 단에서 설정하는 코드를 넣어주어야 한다.<p>예전에는 <code>/proc/&lt;pid>/seccomp</code> 파일의 값을 통해 활성화 했었던 것 같으나, <code>prctl</code> 혹은 <code>sys_seccomp</code>를 통해서 설정되는 것으로 바뀌었다. (언제부터인지는 모르겠다…)<p>본 포스트에서는 <code>prctl</code> 함수를 통한 SECCOMP 기법을 기술한다.<h2 id=0x01-prctl-hamsu><a aria-label="Anchor link for: 0x01-prctl-hamsu" class="header-anchor no-hover-padding" href=#0x01-prctl-hamsu><span aria-hidden=true class=link-icon></span></a> 0x01. prctl 함수</h2><pre class="language-c z-code" data-lang=c><code class=language-c data-lang=c><span class="z-source z-c"><span class="z-storage z-type z-c">int</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">prctl</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-storage z-type z-c">int</span> <span class="z-variable z-parameter z-c">option</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-keyword z-operator z-variadic z-c">...</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c">            <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> unsigned long arg2, unsigned long arg3,
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-comment z-block z-c">            unsigned long arg4, unsigned long arg5 <span class="z-punctuation z-definition z-comment z-c">*/</span></span> <span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></code></pre><p><code>prctl</code> 함수는 프로세스나 쓰레드의 속성을 관리하기 위한 함수이다(PRocess ConTroL). 자세하게 설명할 SECCOMP 적용 이외에도 프로세스 이름을 얻는다든가, 엔디안 상태를 얻는다든가하는 다양한 행위를 할 수 있다. 원하는 행위에 따라 가변 인자를 받아서 동작하는 구조이다.<pre class="language-c z-code" data-lang=c><code class=language-c data-lang=c><span class="z-source z-c"><span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> Values to pass as first argument to prctl() <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_SET_PDEATHSIG</span></span><span class="z-meta z-preprocessor z-macro z-c">  <span class="z-constant z-numeric z-integer z-decimal z-c">1</span>  <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> Second arg is a signal <span class="z-punctuation z-definition z-comment z-c">*/</span></span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_GET_PDEATHSIG</span></span><span class="z-meta z-preprocessor z-macro z-c">  <span class="z-constant z-numeric z-integer z-decimal z-c">2</span>  <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> Second arg is a ptr to return the signal <span class="z-punctuation z-definition z-comment z-c">*/</span></span></span>
</span><span class="z-source z-c"><span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> Get/set current->mm->dumpable <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_GET_DUMPABLE</span></span><span class="z-meta z-preprocessor z-macro z-c">   <span class="z-constant z-numeric z-integer z-decimal z-c">3</span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_SET_DUMPABLE</span></span><span class="z-meta z-preprocessor z-macro z-c">   <span class="z-constant z-numeric z-integer z-decimal z-c">4</span></span>
</span><span class="z-source z-c"><span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> Get/set unaligned access control bits (if meaningful) <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_GET_UNALIGN</span></span><span class="z-meta z-preprocessor z-macro z-c">    <span class="z-constant z-numeric z-integer z-decimal z-c">5</span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_SET_UNALIGN</span></span><span class="z-meta z-preprocessor z-macro z-c">    <span class="z-constant z-numeric z-integer z-decimal z-c">6</span></span>
</span><span class="z-source z-c"><span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> Set/Get process name <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_SET_NAME</span></span><span class="z-meta z-preprocessor z-macro z-c">    <span class="z-constant z-numeric z-integer z-decimal z-c">15</span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_GET_NAME</span></span><span class="z-meta z-preprocessor z-macro z-c">    <span class="z-constant z-numeric z-integer z-decimal z-c">16</span></span>
</span><span class="z-source z-c"><span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> Get/set process endian <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_GET_ENDIAN</span></span><span class="z-meta z-preprocessor z-macro z-c">   <span class="z-constant z-numeric z-integer z-decimal z-c">19</span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_SET_ENDIAN</span></span><span class="z-meta z-preprocessor z-macro z-c">   <span class="z-constant z-numeric z-integer z-decimal z-c">20</span></span>
</span><span class="z-source z-c"><span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> Get/set process seccomp mode <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
</span><span class="z-source z-c"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> -----------------------------------------
</span></span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_GET_SECCOMP</span></span><span class="z-meta z-preprocessor z-macro z-c">  <span class="z-constant z-numeric z-integer z-decimal z-c">21</span>                <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> |</span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_SET_SECCOMP</span></span><span class="z-meta z-preprocessor z-macro z-c">  <span class="z-constant z-numeric z-integer z-decimal z-c">22</span>                <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> |</span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_SET_NO_NEW_PRIVS</span></span><span class="z-meta z-preprocessor z-macro z-c">     <span class="z-constant z-numeric z-integer z-decimal z-c">38</span>        <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> |</span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_GET_NO_NEW_PRIVS</span></span><span class="z-meta z-preprocessor z-macro z-c">     <span class="z-constant z-numeric z-integer z-decimal z-c">39</span>        <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> |</span></span>
</span><span class="z-source z-c"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> -----------------------------------------
</span></span></code></pre><p><code>prctl.h</code>를 확인해보면 첫 번째 인자인 <code>option</code>에 들어가는 매크로의 값들을 확인할 수 있다. 이 중에서 SECCOMP와 관련이 있는 <code>PR_SET_NO_NEW_PRIVS</code>와 <code>PR_SET_SECCOMP</code>에 대해 자세히 알아보자.<h3 id=pr-set-no-new-privs><a aria-label="Anchor link for: pr-set-no-new-privs" class="header-anchor no-hover-padding" href=#pr-set-no-new-privs><span aria-hidden=true class=link-icon></span></a> PR_SET_NO_NEW_PRIVS</h3><pre class="language-c z-code" data-lang=c><code class=language-c data-lang=c><span class="z-source z-c"><span class="z-storage z-type z-c">int</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">prctl</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-variable z-parameter z-c">PR_SET_NO_NEW_PRIVS</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">int</span> <span class="z-variable z-parameter z-c">value</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></code></pre><p>현재 프로세스의 <code>no_new_privs</code> 속성을 <code>value</code> 값으로 설정해주는 동작을 수행한다.<p>이 속성은 리눅스 커널 4.10 이후부터는 <code>/proc/&lt;pid>/status</code>의 <code>NoNewPrivs</code> 필드에서 확인할 수 있다고 한다. 이 속성이 1으로 설정되어있으면 현재 프로세스와 자식 프로세스에서 새로운 권한을 주는 명령을 수행할 수 없게 된다. 다만 권한을 제거하는 명령은 여전히 수행할 수 있다고 한다.<p>이 속성이 왜 중요한지는 <a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#seccomp-mode-filter>SECCOMP_MODE_FILTER</a> 파트에서 서술하겠다.<h3 id=pr-set-seccomp><a aria-label="Anchor link for: pr-set-seccomp" class="header-anchor no-hover-padding" href=#pr-set-seccomp><span aria-hidden=true class=link-icon></span></a> PR_SET_SECCOMP</h3><pre class="language-c z-code" data-lang=c><code class=language-c data-lang=c><span class="z-source z-c"><span class="z-storage z-type z-c">int</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">prctl</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-variable z-parameter z-c">PR_SET_SECCOMP</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">int</span> <span class="z-variable z-parameter z-c">mode</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span><span class="z-keyword z-operator z-variadic z-c">...</span><span class="z-punctuation z-section z-brackets z-end z-c">]</span></span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></code></pre><p>드디어 SECCOMP를 실제 적용하는 부분으로, 두 가지 모드가 존재한다.<pre class="language-c z-code" data-lang=c><code class=language-c data-lang=c><span class="z-source z-c"> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> Valid values for seccomp.mode and prctl(PR_SET_SECCOMP, &lt;mode>) <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
</span><span class="z-source z-c"> <span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">SECCOMP_MODE_DISABLED</span></span><span class="z-meta z-preprocessor z-macro z-c">   <span class="z-constant z-numeric z-integer z-decimal z-c">0</span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> seccomp is not in use. <span class="z-punctuation z-definition z-comment z-c">*/</span></span></span>
</span><span class="z-source z-c"> <span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">SECCOMP_MODE_STRICT</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> uses hard-coded filter. <span class="z-punctuation z-definition z-comment z-c">*/</span></span></span>
</span><span class="z-source z-c"> <span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">SECCOMP_MODE_FILTER</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-constant z-numeric z-integer z-decimal z-c">2</span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> uses user-supplied filter. <span class="z-punctuation z-definition z-comment z-c">*/</span></span></span>
</span></code></pre><p><code>seccomp.h</code>를 확인해보면 모드가 각각 매크로로 정의되어있다.<h4 id=seccomp-mode-strict><a aria-label="Anchor link for: seccomp-mode-strict" class="header-anchor no-hover-padding" href=#seccomp-mode-strict><span aria-hidden=true class=link-icon></span></a> SECCOMP_MODE_STRICT</h4><p><code>read</code>, <code>write</code>, <code>exit</code>, <code>sigreturn</code> 네 가지 syscall만 가능한 모드로 이미 가능한 syscall이 정해져있기 때문에 세 번째 인자가 필요없다.<pre class="language-c z-code" data-lang=c><code class=language-c data-lang=c><span class="z-source z-c"><span class="z-meta z-preprocessor z-include z-c"><span class="z-keyword z-control z-import z-include z-c">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&lt;</span>stdio.h<span class="z-punctuation z-definition z-string z-end z-c">></span></span>
</span></span><span class="z-source z-c"><span class="z-meta z-preprocessor z-include z-c"><span class="z-keyword z-control z-import z-include z-c">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&lt;</span>sys/prctl.h<span class="z-punctuation z-definition z-string z-end z-c">></span></span>
</span></span><span class="z-source z-c"><span class="z-meta z-preprocessor z-include z-c"><span class="z-keyword z-control z-import z-include z-c">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&lt;</span>linux/seccomp.h<span class="z-punctuation z-definition z-string z-end z-c">></span></span>
</span></span><span class="z-source z-c">
</span><span class="z-source z-c"><span class="z-storage z-type z-c">int</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">main</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c"> </span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">        <span class="z-storage z-type z-c">int</span> fd<span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">        <span class="z-storage z-type z-c">char</span> buf<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span><span class="z-constant z-numeric z-integer z-decimal z-c">16</span><span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span><span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-section z-block z-end z-c">}</span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">        <span class="z-keyword z-control z-c">if</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">prctl</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">PR_SET_SECCOMP<span class="z-punctuation z-separator z-c">,</span> SECCOMP_MODE_STRICT</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span> <span class="z-keyword z-operator z-comparison z-c">!=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">                <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">perror</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">"</span>SET_SECCOMP error<span class="z-punctuation z-definition z-string z-end z-c">"</span></span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">        <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">        <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">read</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> buf<span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">16</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">        <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">write</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-separator z-c">,</span> buf</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">        fd <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">open</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">"</span>a.txt<span class="z-punctuation z-definition z-string z-end z-c">"</span></span><span class="z-punctuation z-separator z-c">,</span> <span class="z-string z-quoted z-single z-c"><span class="z-punctuation z-definition z-string z-begin z-c">'</span>w<span class="z-punctuation z-definition z-string z-end z-c">'</span></span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">        <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">write</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">fd<span class="z-punctuation z-separator z-c">,</span> buf</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">        <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">close</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">fd</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">        <span class="z-keyword z-control z-flow z-return z-c">return</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre><p>예시 코드를 컴파일해서 실행한 결과, <code>open</code>에서 <code>SIGKILL</code>이 발생했다.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> ./strict</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">hihi</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">hihi</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[1]</span></span><span class="z-meta z-function-call z-arguments z-shell">    517393 killed     ./strict</span>
</span></code></pre><h4 id=seccomp-mode-filter><a aria-label="Anchor link for: seccomp-mode-filter" class="header-anchor no-hover-padding" href=#seccomp-mode-filter><span aria-hidden=true class=link-icon></span></a> SECCOMP_MODE_FILTER</h4><p>사용자가 직접 어떤 syscall을 차단할지 룰 셋을 만들어서 SECCOMP를 설정하는 모드이다. 앞서 언급한 <code>PR_SET_NO_NEW_PRIVS</code>를 통해 <code>no_new_privs</code> 속성이 설정되어야 filter 모드를 실행할 수 있다.<p>이 때 룰 셋은 Berkeley Packet Filter(BPF)라는 어셈블리같은 문법을 사용하는데, <a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#0x03-seccomp-tools>seccomp-tools</a> 부분에서 자세하게 다뤄보자. 다음은 <code>write</code> syscall을 호출하지 못하게 필터링한 모드의 예시 코드이다.<pre class="language-c z-code" data-lang=c><code class=language-c data-lang=c><span class="z-source z-c"><span class="z-meta z-preprocessor z-include z-c"><span class="z-keyword z-control z-import z-include z-c">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&lt;</span>stdio.h<span class="z-punctuation z-definition z-string z-end z-c">></span></span>
</span></span><span class="z-source z-c"><span class="z-meta z-preprocessor z-include z-c"><span class="z-keyword z-control z-import z-include z-c">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&lt;</span>sys/prctl.h<span class="z-punctuation z-definition z-string z-end z-c">></span></span>
</span></span><span class="z-source z-c"><span class="z-meta z-preprocessor z-include z-c"><span class="z-keyword z-control z-import z-include z-c">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&lt;</span>linux/seccomp.h<span class="z-punctuation z-definition z-string z-end z-c">></span></span>
</span></span><span class="z-source z-c">
</span><span class="z-source z-c"><span class="z-storage z-modifier z-c">static</span> <span class="z-storage z-type z-c">unsigned</span> <span class="z-storage z-type z-c">char</span> filter<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span><span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    <span class="z-constant z-numeric z-integer z-decimal z-c">32</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span>    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> A = sys_number
</span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    <span class="z-constant z-numeric z-integer z-decimal z-c">21</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span>    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> if (A == write) goto 0003
</span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    <span class="z-constant z-numeric z-integer z-decimal z-c">6</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">255</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">127</span><span class="z-punctuation z-separator z-c">,</span>    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> return ALLOW
</span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    <span class="z-constant z-numeric z-integer z-decimal z-c">6</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span>        <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> return KILL
</span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span><span class="z-source z-c">
</span><span class="z-source z-c"><span class="z-meta z-struct z-c"><span class="z-storage z-type z-c">struct</span> <span class="z-meta z-struct z-c"><span class="z-entity z-name z-struct z-c">sock_fprog</span></span></span><span class="z-meta z-struct z-c"> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-struct z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-struct z-c"><span class="z-meta z-block z-c">    <span class="z-storage z-type z-c">unsigned</span> <span class="z-storage z-type z-c">short</span> len<span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-struct z-c"><span class="z-meta z-block z-c">    <span class="z-storage z-type z-c">unsigned</span> <span class="z-storage z-type z-c">char</span> <span class="z-keyword z-operator z-c">*</span>filter<span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-struct z-c"><span class="z-meta z-block z-c"></span></span><span class="z-meta z-struct z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span><span class="z-source z-c">
</span><span class="z-source z-c"><span class="z-storage z-type z-c">int</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">main</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c"> </span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-storage z-type z-c">int</span> fd<span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-storage z-type z-c">char</span> buf<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span><span class="z-constant z-numeric z-integer z-decimal z-c">16</span><span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span><span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-section z-block z-end z-c">}</span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-storage z-type z-c">struct</span> sock_fprog prog<span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-keyword z-control z-c">if</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">prctl</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">PR_SET_NO_NEW_PRIVS<span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span> <span class="z-keyword z-operator z-comparison z-c">!=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">        <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">perror</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">"</span>SET_NO_NEW_PRIVS error<span class="z-punctuation z-definition z-string z-end z-c">"</span></span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    prog<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">len</span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-keyword z-operator z-word z-c">sizeof</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span><span class="z-meta z-group z-c">filter</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-arithmetic z-c">/</span> <span class="z-constant z-numeric z-integer z-decimal z-c">8</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    prog<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">filter</span> <span class="z-keyword z-operator z-assignment z-c">=</span> filter<span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-keyword z-control z-c">if</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">prctl</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">PR_SET_SECCOMP<span class="z-punctuation z-separator z-c">,</span> SECCOMP_MODE_FILTER<span class="z-punctuation z-separator z-c">,</span> <span class="z-keyword z-operator z-c">&</span>prog</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span> <span class="z-keyword z-operator z-comparison z-c">!=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">        <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">perror</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">"</span>SET_SECCOMP error<span class="z-punctuation z-definition z-string z-end z-c">"</span></span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">read</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> buf<span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">16</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">write</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-separator z-c">,</span> buf</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>          <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> &lt;----- This will be blocked
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    fd <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">open</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">"</span>a.txt<span class="z-punctuation z-definition z-string z-end z-c">"</span></span><span class="z-punctuation z-separator z-c">,</span> <span class="z-string z-quoted z-single z-c"><span class="z-punctuation z-definition z-string z-begin z-c">'</span>w<span class="z-punctuation z-definition z-string z-end z-c">'</span></span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">write</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">fd<span class="z-punctuation z-separator z-c">,</span> buf</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">close</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">fd</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-keyword z-control z-flow z-return z-c">return</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre><pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> ./filter</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">hihi</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[1]</span></span><span class="z-meta z-function-call z-arguments z-shell">    669145 invalid system call (core dumped</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">./filter</span></span>
</span></code></pre><p>예시 코드를 컴파일해서 실행한 결과, <code>write</code>에서 <code>SIGSYS</code>가 발생했다. Strict mode에서의 <code>SIGKILL</code>과는 다른 메세지가 출력되길래 디버깅을 해봤는데 filter mode에서는 <code>SIGSYS</code>로 인해 프로세스가 종료되는 것을 확인했다.<h2 id=0x03-seccomp-tools><a aria-label="Anchor link for: 0x03-seccomp-tools" class="header-anchor no-hover-padding" href=#0x03-seccomp-tools><span aria-hidden=true class=link-icon></span></a> 0x03 seccomp-tools</h2><p><code>SECCOMP_MODE_FILTER</code>의 예시 코드를 보면, <code>filter</code> 배열에 필터링 룰을 바이트 코드처럼 바꾸어서 넣어야 한다. 하지만 아무리 숙련자라고 하더라도 원하는 BPF 룰을 자유자재로 바이트 코드화 하기는 어렵다. 이럴 때 쓰기 좋은 것이 바로 seccomp-tools이다.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> sudo apt install gcc ruby-dev<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>y</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> gem install seccomp-tools</span>
</span></code></pre><p>seccomp-tools 설치는 위와 같이 하면 된다.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> seccomp-tools</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Usage:</span></span><span class="z-meta z-function-call z-arguments z-shell"> seccomp-tools <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>-<span class="z-keyword z-operator z-word z-shell">-</span>version<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span> <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>-<span class="z-keyword z-operator z-word z-shell">-</span>help<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span> <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>command<span class="z-keyword z-operator z-assignment z-redirection z-shell">></span> <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>&lt;options><span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span></span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">List</span></span><span class="z-meta z-function-call z-arguments z-shell"> of commands:</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash">        <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">asm</span></span><span class="z-meta z-function-call z-arguments z-shell">     Seccomp bpf assembler.</span>
</span><span class="z-source z-shell z-bash">        <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">disasm</span></span><span class="z-meta z-function-call z-arguments z-shell">  Disassemble seccomp bpf.</span>
</span><span class="z-source z-shell z-bash">        <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">dump</span></span><span class="z-meta z-function-call z-arguments z-shell">    Automatically dump seccomp bpf from execution file(s</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-meta z-function-call z-shell"><span class="z-support z-function z-dot z-shell">.</span></span>
</span><span class="z-source z-shell z-bash">        <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">emu</span></span><span class="z-meta z-function-call z-arguments z-shell">     Emulate seccomp rules.</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">See</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>seccomp-tools &lt;command> --help<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span> to read about a specific subcommand.</span>
</span></code></pre><p>Usage에서 확인할 수 있듯이 <code>asm</code>, <code>disasm</code>, <code>dump</code>, <code>emu</code> 기능을 지원하고 있다.<h3 id=asm><a aria-label="Anchor link for: asm" class="header-anchor no-hover-padding" href=#asm><span aria-hidden=true class=link-icon></span></a> asm</h3><p>BPF로 작성한 룰을 바이트 코드로 변환해주는 기능으로 BPF는 주로 다음과 같이 작성한다.<pre class="language-txt z-code" data-lang=txt><code class=language-txt data-lang=txt><span class="z-text z-plain">A = arch
</span><span class="z-text z-plain">if (A != ARCH_X86_64) goto dead
</span><span class="z-text z-plain">A = sys_number
</span><span class="z-text z-plain">if (A >= 0x40000000) goto dead
</span><span class="z-text z-plain">if (A == write) goto ok
</span><span class="z-text z-plain">if (A == close) goto ok
</span><span class="z-text z-plain">if (A == dup) goto ok
</span><span class="z-text z-plain">if (A == exit) goto ok
</span><span class="z-text z-plain">return ERRNO(5)
</span><span class="z-text z-plain">ok:
</span><span class="z-text z-plain">return ALLOW
</span><span class="z-text z-plain">dead:
</span><span class="z-text z-plain">return KILL
</span></code></pre><p>뜬금없이 <code>A</code>라는 변수가 등장해서 처음에 뭐지 싶었는데, 그냥 임의 변수라고 생각하면 편하다.<p>이제 이 내용을 파일로 저장해서 seccomp-tools의 인자로 전달해주면 된다.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> seccomp-tools asm rule.txt</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span> \x00\x00\x00\x04\x00\x00\x00\x15\x00\x00\b>\x00\x00\xC0 \x00\x00\x00\x00\x00\x00\x005\x00\x06\x00\x00\x00\x00@\x15\x00\x04\x00\x01\x00\x00\x00\x15\x00\x03\x00\x03\x00\x00\x00\x15\x00\x02\x00 \x00\x00\x00\x15\x00\x01\x00&lt;\x00\x00\x00\x06\x00\x00\x00\x05\x00\x05\x00\x06\x00\x00\x00\x00\x00\xFF\x7F\x06\x00\x00\x00\x00\x00\x00\x00<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span></span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> seccomp-tools asm rule.txt<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>f</span> c_array</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">unsigned</span></span><span class="z-meta z-function-call z-arguments z-shell"> char bpf<span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span><span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span> = <span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span>32<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>4<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>21<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>8<span class="z-punctuation z-separator z-shell">,</span>62<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>192<span class="z-punctuation z-separator z-shell">,</span>32<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>53<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>6<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>64<span class="z-punctuation z-separator z-shell">,</span>21<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>4<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>1<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>21<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>3<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>3<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>21<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>2<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>32<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>21<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>1<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>60<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>6<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>5<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>5<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>6<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>255<span class="z-punctuation z-separator z-shell">,</span>127<span class="z-punctuation z-separator z-shell">,</span>6<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> seccomp-tools asm rule.txt<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>f</span> c_source</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell">include &lt;linux/seccomp.h></span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell">include &lt;stdio.h></span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell">include &lt;stdlib.h></span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell">include &lt;sys/prctl.h></span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">static</span></span><span class="z-meta z-function-call z-arguments z-shell"> void install_seccomp(</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-punctuation z-definition z-compound z-braces z-begin z-shell">{</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">static</span></span><span class="z-meta z-function-call z-arguments z-shell"> unsigned char filter<span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span><span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span> = <span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span>32<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>4<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>21<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>8<span class="z-punctuation z-separator z-shell">,</span>62<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>192<span class="z-punctuation z-separator z-shell">,</span>32<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>53<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>6<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>64<span class="z-punctuation z-separator z-shell">,</span>21<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>4<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>1<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>21<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>3<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>3<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>21<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>2<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>32<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>21<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>1<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>60<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>6<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>5<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>5<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>6<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>255<span class="z-punctuation z-separator z-shell">,</span>127<span class="z-punctuation z-separator z-shell">,</span>6<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">struct</span></span><span class="z-meta z-function-call z-arguments z-shell"> prog <span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">    unsigned short len;
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">    unsigned char <span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span>filter;
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">  <span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span> rule = <span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">    .len = sizeof(filter) >> 3<span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">    .filter = filter
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">  <span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span><span class="z-source z-shell z-bash">  <span class="z-keyword z-control z-conditional z-if z-shell">if</span><span class="z-punctuation z-definition z-compound z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">prctl</span></span><span class="z-meta z-function-call z-arguments z-shell">(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0</span><span class="z-punctuation z-definition z-compound z-end z-shell">)</span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span> <span class="z-constant z-numeric z-integer z-decimal z-file-descriptor z-shell">0</span></span><span class="z-meta z-function-call z-shell"></span>) <span class="z-punctuation z-definition z-compound z-braces z-begin z-shell">{</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">perror</span></span><span class="z-meta z-function-call z-arguments z-shell">(<span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>prctl(PR_SET_NO_NEW_PRIVS)<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span><span class="z-meta z-function-call z-shell"></span>)<span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">exit</span></span><span class="z-meta z-function-call z-arguments z-shell">(2</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-punctuation z-definition z-compound z-braces z-end z-shell">}</span>
</span><span class="z-source z-shell z-bash">  <span class="z-keyword z-control z-conditional z-if z-shell">if</span><span class="z-punctuation z-definition z-compound z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">prctl</span></span><span class="z-meta z-function-call z-arguments z-shell">(PR_SET_SECCOMP, SECCOMP_MODE_FILTER,</span> <span class="z-keyword z-operator z-logical z-job z-shell">&</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">rule</span></span><span class="z-punctuation z-definition z-compound z-end z-shell">)</span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span> <span class="z-constant z-numeric z-integer z-decimal z-file-descriptor z-shell">0</span></span><span class="z-meta z-function-call z-shell"></span>) <span class="z-punctuation z-definition z-compound z-braces z-begin z-shell">{</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">perror</span></span><span class="z-meta z-function-call z-arguments z-shell">(<span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>prctl(PR_SET_SECCOMP)<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span><span class="z-meta z-function-call z-shell"></span>)<span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">exit</span></span><span class="z-meta z-function-call z-arguments z-shell">(2</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-punctuation z-definition z-compound z-braces z-end z-shell">}</span>
</span><span class="z-source z-shell z-bash"><span class="z-punctuation z-definition z-compound z-braces z-end z-shell">}</span>
</span></code></pre><p>예시를 보면 결과를 다양한 포맷으로 출력할 수 있는데, -f 옵션에 <code>raw</code>, <code>c_array</code>, <code>c_source</code>, <code>assembly</code> 등 바로 사용하기 좋은 포맷들이 있다.<h3 id=disasm><a aria-label="Anchor link for: disasm" class="header-anchor no-hover-padding" href=#disasm><span aria-hidden=true class=link-icon></span></a> disasm</h3><p><code>asm</code>과는 반대로 바이트 코드 형식의 BPF를 필터링 룰로 변환해준다. 입력 파일로 바이트 코드가 저장된 파일을 인자로 주면 된다.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> xxd rule.raw</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">00000000:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 2000 0000 0400 0000 1500 0008 3e00 00c0   ...........<span class="z-keyword z-operator z-assignment z-redirection z-shell">></span>...</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">00000010:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 2000 0000 0000 0000 3500 0600 0000 0040   .......5......@</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">00000020:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 1500 0400 0100 0000 1500 0300 0300 0000  ................</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">00000030:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 1500 0200 2000 0000 1500 0100 3c00 0000  .... .......<span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>...</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">00000040:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0600 0000 0500 0500 0600 0000 0000 ff7f  ................</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">00000050:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0600 0000 0000 0000                      ........</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> seccomp-tools disasm rule.raw</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">line</span></span><span class="z-meta z-function-call z-arguments z-shell">  CODE  JT   JF      K</span>
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">================================</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0000:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x20 0x00 0x00 0x00000004  A = arch</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0001:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x00 0x08 0xc000003e  if (A != ARCH_X86_64</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0010</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0002:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x20 0x00 0x00 0x00000000  A = sys_number</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0003:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x35 0x06 0x00 0x40000000  if (A <span class="z-keyword z-operator z-assignment z-redirection z-shell">></span>= 0x40000000</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0010</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0004:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x04 0x00 0x00000001  if (A == write</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0009</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0005:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x03 0x00 0x00000003  if (A == close</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0009</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0006:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x02 0x00 0x00000020  if (A == dup</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0009</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0007:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x01 0x00 0x0000003c  if (A == exit</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0009</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0008:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x06 0x00 0x00 0x00050005  return ERRNO(5</span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0009:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x06 0x00 0x00 0x7fff0000  return ALLOW</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0010:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x06 0x00 0x00 0x00000000  return KILL</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> seccomp-tools asm rule.txt<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>f</span> raw</span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">seccomp-tools</span></span><span class="z-meta z-function-call z-arguments z-shell"> disasm -</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">line</span></span><span class="z-meta z-function-call z-arguments z-shell">  CODE  JT   JF      K</span>
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">================================</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0000:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x20 0x00 0x00 0x00000004  A = arch</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0001:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x00 0x08 0xc000003e  if (A != ARCH_X86_64</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0010</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0002:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x20 0x00 0x00 0x00000000  A = sys_number</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0003:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x35 0x06 0x00 0x40000000  if (A <span class="z-keyword z-operator z-assignment z-redirection z-shell">></span>= 0x40000000</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0010</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0004:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x04 0x00 0x00000001  if (A == write</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0009</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0005:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x03 0x00 0x00000003  if (A == close</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0009</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0006:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x02 0x00 0x00000020  if (A == dup</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0009</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0007:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x01 0x00 0x0000003c  if (A == exit</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0009</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0008:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x06 0x00 0x00 0x00050005  return ERRNO(5</span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0009:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x06 0x00 0x00 0x7fff0000  return ALLOW</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0010:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x06 0x00 0x00 0x00000000  return KILL</span>
</span></code></pre><p><code>asm</code>기능과 연계해서 출력값을 <code>raw</code> 포맷으로 지정한 뒤 파이프라인을 연결해주면 BPF 룰이 제대로 작성되었는지 확인할 수 있다.<h3 id=dump><a aria-label="Anchor link for: dump" class="header-anchor no-hover-padding" href=#dump><span aria-hidden=true class=link-icon></span></a> dump</h3><p>바이너리 내에 적용되는 BPF 룰을 출력해주는 기능이다. 동작 방식이 궁금해서 찾아보니 <code>ptrace</code>를 이용하여 동적으로 분석해주는 모양이다.<p>단 첫 번째 <code>prctl(PR_SET_SECCOMP)</code>를 기준으로 룰을 출력해주기 때문에 <code>prctl</code> 함수가 여러번 호출된다면 실제와 다를 수 있다. 그럴 때는 <code>-l</code> 혹은 <code>--limit</code> 옵션을 줘서 검사할 <code>prctl</code> 함수의 개수를 늘릴 수 있다.<p>또한 <code>-p</code> 혹은 <code>--pid</code> 옵션을 줘서 현재 실행중인 프로세스에 걸려있는 룰을 확인할 수도 있다.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> seccomp-tools dump ./filter</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">line</span></span><span class="z-meta z-function-call z-arguments z-shell">  CODE  JT   JF      K</span>
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">================================</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0000:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x20 0x00 0x00 0x00000004  A = arch</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0001:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x00 0x03 0xc000003e  if (A != ARCH_X86_64</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0005</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0002:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x20 0x00 0x00 0x00000000  A = sys_number</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0003:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x01 0x00 0x00000001  if (A == write</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0005</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0004:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x06 0x00 0x00 0x7fff0000  return ALLOW</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0005:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x06 0x00 0x00 0x00000000  return KILL</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> sudo seccomp-tools dump<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">pgrep</span></span><span class="z-meta z-function-call z-arguments z-shell"> filter</span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span></span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">line</span></span><span class="z-meta z-function-call z-arguments z-shell">  CODE  JT   JF      K</span>
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">================================</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0000:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x20 0x00 0x00 0x00000004  A = arch</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0001:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x00 0x03 0xc000003e  if (A != ARCH_X86_64</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0005</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0002:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x20 0x00 0x00 0x00000000  A = sys_number</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0003:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x01 0x00 0x00000001  if (A == write</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0005</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0004:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x06 0x00 0x00 0x7fff0000  return ALLOW</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0005:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x06 0x00 0x00 0x00000000  return KILL</span>
</span></code></pre><p><code>dump</code> 기능을 이렇게 활용할 수 있다.<h3 id=emu><a aria-label="Anchor link for: emu" class="header-anchor no-hover-padding" href=#emu><span aria-hidden=true class=link-icon></span></a> emu</h3><p><code>emu</code>는 룰셋을 에뮬레이팅해서 syscall이 잘 호출되는지 혹은 잘 차단되는지를 확인하기 좋은 기능이다.<p><code>bash</code>에서 사용하면 색깔이 입혀져서 출력이 나오기 때문에 보기 편하다.<p><img alt=image src=https://github.com/user-attachments/assets/386bcaed-3ac9-4bd9-b084-8bc85ff8f442><p><img alt=image src=https://github.com/user-attachments/assets/31a4405c-73b6-4427-8868-2352f33690e3><h2 id=0x04-expected-vulnerability><a aria-label="Anchor link for: 0x04-expected-vulnerability" class="header-anchor no-hover-padding" href=#0x04-expected-vulnerability><span aria-hidden=true class=link-icon></span></a> 0x04. Expected Vulnerability</h2><p>당연히 코딩을 어떻게 하느냐에 따라 다르겠지만 발생할 법한 취약점들을 생각해보았다. 좋은 아이디어나 댓글이 있다면 추가할 예정이다.<h3 id=x32-syscall><a aria-label="Anchor link for: x32-syscall" class="header-anchor no-hover-padding" href=#x32-syscall><span aria-hidden=true class=link-icon></span></a> x32 Syscall</h3><p>앞선 seccomp-tools <code>disasm</code>의 예시에서 이런 룰이 있었다.<pre class="language-txt z-code" data-lang=txt><code class=language-txt data-lang=txt><span class="z-text z-plain">0000: 0x20 0x00 0x00 0x00000004  A = arch
</span><span class="z-text z-plain">0001: 0x15 0x00 0x08 0xc000003e  if (A != ARCH_X86_64) goto 0010
</span><span class="z-text z-plain">0002: 0x20 0x00 0x00 0x00000000  A = sys_number
</span><span class="z-text z-plain">0003: 0x35 0x06 0x00 0x40000000  if (A >= 0x40000000) goto 0010
</span></code></pre><p><code>0001</code> 라인은 아키텍처가 <code>X86_64</code>인지 확인하는 로직이고, <code>0003</code> 라인의 <code>sys_number</code>가 <code>0x40000000</code>보다 큰지는 왜 확인하는걸까?<p>이유는 <code>X86_64</code> 아키텍처의 호환성에 있다. 64비트 아키텍처에서 이전 32비트에서 사용하던 명령어들을 그대로 사용할 수 있게끔 개발되었는데, 이런걸 x32 ABI라고 한다. 때문에 64비트 아키텍처에서도 32비트의 syscall을 호출할 수 있는데, 그 방법이 리눅스에서는 64bit syscall number에 <code>0x40000000</code>을 더하는 것이다.<p>실제 리눅스 커널에서 32비트 syscall을 호출했을 때 호출되는 <code>do_syscall_x32</code> 함수의 코드를 보자.<pre class="language-c z-code" data-lang=c><code class=language-c data-lang=c><span class="z-source z-c"><span class="z-storage z-modifier z-c">static</span> __always_inline <span class="z-storage z-type z-c">bool</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">do_syscall_x32</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-storage z-type z-c">struct</span> pt_regs <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">regs</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">int</span> <span class="z-variable z-parameter z-c">nr</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span></span><span class="z-source z-c"><span class="z-meta z-function z-c"></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-comment z-block z-c">     <span class="z-punctuation z-definition z-comment z-c">*</span> Adjust the starting offset of the table, and convert numbers
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-comment z-block z-c">     <span class="z-punctuation z-definition z-comment z-c">*</span> &lt; __X32_SYSCALL_BIT to very high and thus out of range
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-comment z-block z-c">     <span class="z-punctuation z-definition z-comment z-c">*</span> numbers for comparisons.
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-comment z-block z-c">     <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-storage z-type z-c">unsigned</span> <span class="z-storage z-type z-c">int</span> xnr <span class="z-keyword z-operator z-assignment z-c">=</span> nr <span class="z-keyword z-operator z-arithmetic z-c">-</span> __X32_SYSCALL_BIT<span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">IS_ENABLED</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">CONFIG_X86_X32_ABI</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span> <span class="z-keyword z-operator z-arithmetic z-c">&&</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">likely</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">xnr <span class="z-keyword z-operator z-comparison z-c">&lt;</span> X32_NR_syscalls</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">        xnr <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">array_index_nospec</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">xnr<span class="z-punctuation z-separator z-c">,</span> X32_NR_syscalls</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">        regs<span class="z-punctuation z-accessor z-c">-></span>ax <span class="z-keyword z-operator z-assignment z-c">=</span> x32_sys_call_table<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>xnr<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>regs<span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">        <span class="z-keyword z-control z-flow z-return z-c">return</span> <span class="z-constant z-language z-c">true</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-keyword z-control z-flow z-return z-c">return</span> <span class="z-constant z-language z-c">false</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre><p>함수의 첫 줄에서 <code>xnr = nr - __X32_SYSCALL_BIT</code>으로 할당이 되는데, 이 때 <code>__X32_SYSCALL_BIT</code> 값이 사전 정의된 <code>0x40000000</code>이라고 한다.<p>따라서 어떤 64비트 바이너리의 BPF 룰에 syscall number가 <code>0x40000000</code>보다 작은지 검증하는 로직이 존재하지 않는다면, 특정 syscall이 차단되었다고 하더라도 x32 ABI를 이용하여 syscall number에 <code>0x40000000</code>을 더해서 32비트 아키텍처의 syscall을 호출할 수 있다.<h3 id=filter-overwrite><a aria-label="Anchor link for: filter-overwrite" class="header-anchor no-hover-padding" href=#filter-overwrite><span aria-hidden=true class=link-icon></span></a> Filter Overwrite</h3><p>가장 단순하게 떠오른 생각으로 메모리에 있는 BPF 필터 룰 부분을 SECCOMP가 설정되기 전에 원하는 값으로 덮을 수 있을 때 발생할 수 있는 취약점이다. 원하는 syscall을 호출할 수 있도록 룰을 바꿔준다든가, 룰을 <code>return ALLOW</code>로 도배한다든가하는 방법이 있을 것이다.<p>이와 관련된 문제가 <a class=external href=https://dreamhack.io>dreamhack.io</a>에 있으니 풀어보길 추천한다.<h3 id=seccomp-bypass><a aria-label="Anchor link for: seccomp-bypass" class="header-anchor no-hover-padding" href=#seccomp-bypass><span aria-hidden=true class=link-icon></span></a> SECCOMP Bypass</h3><p><code>PR_SET_SECCOMP</code> 하다가 알게 된 사실인데, BPF 룰이 좀 잘못되어있으면 prctl 함수가 에러만 리턴하고 프로세스를 종료시키지는 않는다.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cat wrong.txt</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">A</span></span><span class="z-meta z-function-call z-arguments z-shell"> = sys_number</span>
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-control z-conditional z-if z-shell">if</span> <span class="z-punctuation z-definition z-compound z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">A</span></span><span class="z-meta z-function-call z-arguments z-shell"> == write</span><span class="z-punctuation z-definition z-compound z-end z-shell">)</span><span class="z-meta z-function-call z-arguments z-shell"> goto 3</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-keyword z-control z-flow z-return z-shell">return</span></span><span class="z-meta z-function-call z-arguments z-shell"> ALLOW</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-keyword z-control z-flow z-return z-shell">return</span></span><span class="z-meta z-function-call z-arguments z-shell"> KILL</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> seccomp-tools asm wrong.txt<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>f</span> raw</span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">seccomp-tools</span></span><span class="z-meta z-function-call z-arguments z-shell"> disasm -</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">line</span></span><span class="z-meta z-function-call z-arguments z-shell">  CODE  JT   JF      K</span>
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">================================</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0000:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x20 0x00 0x00 0x00000000  A = sys_number</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0001:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x03 0x00 0x00000001  if (A == write</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0005</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0002:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x06 0x00 0x00 0x7fff0000  return ALLOW</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0003:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x06 0x00 0x00 0x00000000  return KILL</span>
</span></code></pre><p>잘못된 BPF룰의 예시로, 잘 보면 0001 라인에서 goto 0005라고 되어있다. <code>wrong.txt</code>를 구성할 때 <code>goto</code>에서 생각 없이 <code>return KILL</code>이 위치하게 될 3번 라인으로 가라고 했는데, 알고보니 상대주소 개념으로 값을 넣어주어야 했다.<p>예를 들어 현재 라인인 0001에서 <code>goto 0</code>이면 다음 라인인 0002, <code>goto 1</code>이면 다음 X 2 라인인 0003으로 가라는 식으로 해석되어서, <code>goto 3</code>은 0005 라인으로 가라는 명령어가 되었다. <code>wrong.txt</code>에는 0005라인이 존재하지 않으니 <code>prctl</code>의 옵션으로 전달 시 에러가 발생한다.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> ./filter</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">SET_SECCOMP</span></span><span class="z-meta z-function-call z-arguments z-shell"> error: Invalid argument</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">hihi</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">hihi</span></span>
</span></code></pre><p>잘못된 룰을 적용했을 때 이런 식으로 SECCOMP 에러가 발생한다. 결과적으로 <code>write</code> syscall을 차단하려는 룰이 적용되지 않아 입력받은 문자열을 <code>STDOUT</code>에 출력할 수 있게 되었다.<p>따라서 Filter Overwrite처럼 필터 전체를 덮어쓰지 못하더라도 몇 바이트로 룰 자체를 말이 안되게 할 수 있다면 에러는 발생하되 프로세스는 유지되므로 SECCOMP bypass가 가능할 것이다.<h2 id=0x05-camgojaryo><a aria-label="Anchor link for: 0x05-camgojaryo" class="header-anchor no-hover-padding" href=#0x05-camgojaryo><span aria-hidden=true class=link-icon></span></a> 0x05. 참고자료</h2><ul><li><a class=external href=https://man7.org/linux/man-pages/man2/prctl.2.html>https://man7.org/linux/man-pages/man2/prctl.2.html</a><li><a class=external href=https://jeongzero.oopy.io/06eebad5-8306-493f-9c6d-e7a04d5aacff>https://jeongzero.oopy.io/06eebad5-8306-493f-9c6d-e7a04d5aacff</a><li><a class=external href=https://velog.io/@woounnan/LINUX-Seccomp>https://velog.io/@woounnan/LINUX-Seccomp</a><li><a class=external href=https://velog.io/@dandb3/SECCOMP2>https://velog.io/@dandb3/SECCOMP2</a><li><a class=external href=https://learn.dreamhack.io/280>https://learn.dreamhack.io/280</a><li><a class=external href=https://github.com/david942j/seccomp-tools>https://github.com/david942j/seccomp-tools</a></ul></section><nav class="full-width article-navigation"><div><a aria-describedby=left_title aria-label=다음 href=https://bl4nk.kr/ko/blog/memod/><span class=arrow>←</span> 다음</a><p aria-hidden=true id=left_title>memod</div><div><a aria-describedby=right_title aria-label=이전 href=https://bl4nk.kr/ko/blog/attaching-to-gdb-with-pwntools/>이전 <span class=arrow>→</span></a><p aria-hidden=true id=right_title>pwntools로 gdb 연결하기</div></nav></article></main><div id=button-container><div id=toc-floating-container><input class=toggle id=toc-toggle type=checkbox><label class=overlay for=toc-toggle></label><label title="목차 토글" class=button for=toc-toggle id=toc-button><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="M414.82-193.094q-18.044 0-30.497-12.32-12.453-12.319-12.453-30.036t12.453-30.086q12.453-12.37 30.497-12.37h392.767q17.237 0 29.927 12.487 12.69 12.486 12.69 30.203 0 17.716-12.69 29.919t-29.927 12.203H414.82Zm0-244.833q-18.044 0-30.497-12.487Q371.87-462.9 371.87-480.45t12.453-29.92q12.453-12.369 30.497-12.369h392.767q17.237 0 29.927 12.511 12.69 12.512 12.69 29.845 0 17.716-12.69 30.086-12.69 12.37-29.927 12.37H414.82Zm0-245.167q-18.044 0-30.497-12.32t-12.453-30.037q0-17.716 12.453-30.086 12.453-12.369 30.497-12.369h392.767q17.237 0 29.927 12.486 12.69 12.487 12.69 30.203 0 17.717-12.69 29.92-12.69 12.203-29.927 12.203H414.82ZM189.379-156.681q-32.652 0-55.878-22.829t-23.226-55.731q0-32.549 23.15-55.647 23.151-23.097 55.95-23.097 32.799 0 55.313 23.484 22.515 23.484 22.515 56.246 0 32.212-22.861 54.893-22.861 22.681-54.963 22.681Zm0-245.167q-32.652 0-55.878-23.134-23.226-23.135-23.226-55.623 0-32.487 23.467-55.517t56.12-23.03q32.102 0 54.721 23.288 22.62 23.288 22.62 55.775 0 32.488-22.861 55.364-22.861 22.877-54.963 22.877Zm-.82-244.833q-32.224 0-55.254-23.288-23.03-23.289-23.03-55.623 0-32.333 23.271-55.364 23.272-23.03 55.495-23.03 32.224 0 55.193 23.288 22.969 23.289 22.969 55.622 0 32.334-23.21 55.364-23.21 23.031-55.434 23.031Z"/></svg></label><div class=toc-content><div class=toc-container><ul><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#0x00-introduction>0x00. Introduction</a><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#0x01-prctl-hamsu>0x01. prctl 함수</a> <ul><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#pr-set-no-new-privs>PR_SET_NO_NEW_PRIVS</a><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#pr-set-seccomp>PR_SET_SECCOMP</a> <ul><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#seccomp-mode-strict>SECCOMP_MODE_STRICT</a><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#seccomp-mode-filter>SECCOMP_MODE_FILTER</a></ul></ul><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#0x03-seccomp-tools>0x03 seccomp-tools</a> <ul><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#asm>asm</a><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#disasm>disasm</a><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#dump>dump</a><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#emu>emu</a></ul><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#0x04-expected-vulnerability>0x04. Expected Vulnerability</a> <ul><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#x32-syscall>x32 Syscall</a><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#filter-overwrite>Filter Overwrite</a><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#seccomp-bypass>SECCOMP Bypass</a></ul><li><a href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/#0x05-camgojaryo>0x05. 참고자료</a></ul></div></div></div><a title="페이지 상단으로" class=no-hover-padding href=# id=top-button> <svg viewbox="0 0 20 20" fill=currentColor><path d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z"/></svg> </a></div><span class=hidden id=copy-success> 복사됨! </span><span class=hidden id=copy-init> 코드를 클립보드에 복사 </span><script defer src=https://bl4nk.kr/js/copyCodeToClipboard.min.js></script></div><footer><section><nav class="socials nav-navs"><ul><li><a class="nav-links no-hover-padding social" href=https://bl4nk.kr/ko/atom.xml> <img alt=feed loading=lazy src=https://bl4nk.kr/social_icons/rss.svg title=feed> </a><li class=js><a class="nav-links no-hover-padding social" data-encoded-email="Ymw0bmtAa29yZWEuYWMua3I=" href=#><img alt=email loading=lazy src=https://bl4nk.kr/social_icons/email.svg title=email> </a><li><a class="nav-links no-hover-padding social" rel=" me" href=https://github.com/fitbl4nk> <img alt=github loading=lazy src=https://bl4nk.kr/social_icons/github.svg title=github> </a></ul></nav><nav class=nav-navs></nav><div class=credits><small> <p><p>~/bl4nk © 2025 bl4nk • Unless otherwise noted, the content in this website is available under the <a class=external href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA 4.0</a> license.</p> Powered_by <a href=https://www.getzola.org>Zola</a> & <a href=https://github.com/welpo/tabi>tabi</a> • <a href=https://github.com/fitbl4nk/bl4nk.kr> Site source </a></small></div></section><script async src=https://bl4nk.kr/js/decodeMail.min.js></script></footer>