<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="default-src 'self';font-src 'self' data:;img-src 'self' https://* data:;media-src 'self';style-src 'self';frame-src player.vimeo.com https://www.youtube-nocookie.com;connect-src 'self';script-src 'self' 'self'" http-equiv=Content-Security-Policy><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://bl4nk.kr name=base><title>~/bl4nk ‚Ä¢ [SECCOMP] SECCOMP using prctl function</title><link href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50%" x="50%" dominant-baseline="central" text-anchor="middle" font-size="88">üçë</text></svg>' rel=icon><link title="~/bl4nk - Atom Feed" href=https://bl4nk.kr/atom.xml rel=alternate type=application/atom+xml><link href="https://bl4nk.kr/custom_subset.css?h=0b9535a28bc3d5bf2321" rel=stylesheet><link href="https://bl4nk.kr/main.css?h=3040ad101081cced976b" rel=stylesheet><link href="https://bl4nk.kr/skins/lavender.css?h=31ee0a710ed660d122f6" rel=stylesheet><meta content="light dark" name=color-scheme><meta media="(prefers-color-scheme: light)" content=#ffffff name=theme-color><meta media="(prefers-color-scheme: dark)" content=#000000 name=theme-color><meta content="From usage of prctl function to related tool and expected vulnerailities" name=description><meta content="From usage of prctl function to related tool and expected vulnerailities" property=og:description><meta content="[SECCOMP] SECCOMP using prctl function" property=og:title><meta content=article property=og:type><meta content=ko_KR property=og:locale:alternate><link href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/ hreflang=ko rel=alternate><meta content=en_GB property=og:locale:alternate><link href=https://bl4nk.kr/blog/seccomp-using-prctl-function/ hreflang=en rel=alternate><link href=https://bl4nk.kr/blog/seccomp-using-prctl-function/ rel=canonical><meta content=https://bl4nk.kr/blog/seccomp-using-prctl-function/ property=og:url><meta content=~/bl4nk property=og:site_name><noscript><link href=https://bl4nk.kr/no_js.css rel=stylesheet></noscript><script src=https://bl4nk.kr/js/initializeTheme.min.js></script><script defer src=https://bl4nk.kr/js/themeSwitcher.min.js></script><script src="https://bl4nk.kr/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body class=use-sans-serif><header><nav class=navbar><div class=nav-title><a class=home-title href=https://bl4nk.kr>~/bl4nk</a></div><div class=nav-navs><ul><li><a class="nav-links no-hover-padding" href=https://bl4nk.kr/about/>about </a><li><a class="nav-links no-hover-padding" href=https://bl4nk.kr/blog/>blog </a><li><a class="nav-links no-hover-padding" href=https://bl4nk.kr/archive/>archive </a><li><a class="nav-links no-hover-padding" href=https://bl4nk.kr/tags/>tags </a><li class=menu-icons-container><ul class=menu-icons-group><li class="js menu-icon"><div aria-label="Click or press $SHORTCUT to open search" class="search-icon interactive-icon" title="Click or press $SHORTCUT to open search" id=search-button role=button tabindex=0><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg></div><li class=language-switcher><details class=dropdown><summary aria-label="Language selection" title="Language selection" aria-haspopup=true role=button><div class=language-switcher-icon></div></summary> <div class=dropdown-content role=menu>English<a aria-label=ÌïúÍµ≠Ïñ¥ href=https://bl4nk.kr/ko/blog/seccomp-using-prctl-function/ lang=ko role=menuitem>ÌïúÍµ≠Ïñ¥</a></div></details><li class="theme-switcher-wrapper js"><div aria-label="Toggle dark mode" title="Toggle dark/light mode" aria-pressed=false class=theme-switcher role=button tabindex=0></div><div aria-label="Reset mode to default" class="theme-resetter arrow" title="Reset mode to default" aria-hidden=true role=button tabindex=0></div></ul></ul></div></nav></header><div class=content><main><article><h1 class=article-title>[SECCOMP] SECCOMP using prctl function</h1><ul class=meta><li>15th Jun 2024<li title="1429 words"><span aria-hidden=true class=separator>‚Ä¢</span>8 min read<li class=tag><span aria-hidden=true class=separator>‚Ä¢</span>Tags:¬†<li class=tag><a href=https://bl4nk.kr/tags/study/>study</a>,¬†<li class=tag><a href=https://bl4nk.kr/tags/linux/>linux</a>,¬†<li class=tag><a href=https://bl4nk.kr/tags/seccomp/>seccomp</a>,¬†<li class=tag><a href=https://bl4nk.kr/tags/mitigation/>mitigation</a></ul><div class=toc-container><h3>Table of Contents</h3><ul><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#0x00-introduction>0x00. Introduction</a><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#0x01-prctl-function>0x01. prctl function</a> <ul><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#pr-set-no-new-privs>PR_SET_NO_NEW_PRIVS</a><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#pr-set-seccomp>PR_SET_SECCOMP</a> <ul><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#seccomp-mode-strict>SECCOMP_MODE_STRICT</a><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#seccomp-mode-filter>SECCOMP_MODE_FILTER</a></ul></ul><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#0x02-seccomp-tools>0x02. seccomp-tools</a> <ul><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#asm>asm</a><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#disasm>disasm</a><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#dump>dump</a><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#emu>emu</a></ul><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#0x03-expected-vulnerability>0x03. Expected Vulnerability</a> <ul><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#x32-syscall>x32 Syscall</a><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#filter-overwrite>Filter Overwrite</a><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#seccomp-bypass>SECCOMP Bypass</a></ul><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#0x04-references>0x04. References</a></ul></div><section class=body><h2 id=0x00-introduction><a aria-label="Anchor link for: 0x00-introduction" class="header-anchor no-hover-padding" href=#0x00-introduction><span aria-hidden=true class=link-icon></span></a> 0x00. Introduction</h2><p>The SECCOMP (SECure COMPuting mode) is a feature of Linux kernel that provides sandboxing of process. In detail, it restricts the syscalls that are executed in the process, and terminates the process (SIGKILL) if a syscall is not allowed one. Unlike other mitigations, it is not applied at compile time, but rather at run time.<p>It seems that it was activated through the value of the <code>/proc/&lt;pid>/seccomp</code> in the past, but it had been changed to be set through <code>prctl</code> or <code>sys_seccomp</code>.(I don‚Äôt know since when‚Ä¶)<p>In this post, I will describe the SECCOMP using the <code>prctl</code> function.<h2 id=0x01-prctl-function><a aria-label="Anchor link for: 0x01-prctl-function" class="header-anchor no-hover-padding" href=#0x01-prctl-function><span aria-hidden=true class=link-icon></span></a> 0x01. prctl function</h2><pre class="language-c z-code" data-lang=c><code class=language-c data-lang=c><span class="z-source z-c"><span class="z-storage z-type z-c">int</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">prctl</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-storage z-type z-c">int</span> <span class="z-variable z-parameter z-c">option</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-keyword z-operator z-variadic z-c">...</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c">            <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> unsigned long arg2, unsigned long arg3,
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-comment z-block z-c">            unsigned long arg4, unsigned long arg5 <span class="z-punctuation z-definition z-comment z-c">*/</span></span> <span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></code></pre><p>The <code>prctl</code> function is a function for managing the properties of processes or threads (PRocess ConTroL). In addition to applying SECCOMP, which will be explained in detail, it can be used to obtain the process name or the endian information. Basically it receives a variable number of arguments and operates according to the desired action.<pre class="language-c z-code" data-lang=c><code class=language-c data-lang=c><span class="z-source z-c"><span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> Values to pass as first argument to prctl() <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_SET_PDEATHSIG</span></span><span class="z-meta z-preprocessor z-macro z-c">  <span class="z-constant z-numeric z-integer z-decimal z-c">1</span>  <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> Second arg is a signal <span class="z-punctuation z-definition z-comment z-c">*/</span></span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_GET_PDEATHSIG</span></span><span class="z-meta z-preprocessor z-macro z-c">  <span class="z-constant z-numeric z-integer z-decimal z-c">2</span>  <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> Second arg is a ptr to return the signal <span class="z-punctuation z-definition z-comment z-c">*/</span></span></span>
</span><span class="z-source z-c"><span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> Get/set current->mm->dumpable <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_GET_DUMPABLE</span></span><span class="z-meta z-preprocessor z-macro z-c">   <span class="z-constant z-numeric z-integer z-decimal z-c">3</span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_SET_DUMPABLE</span></span><span class="z-meta z-preprocessor z-macro z-c">   <span class="z-constant z-numeric z-integer z-decimal z-c">4</span></span>
</span><span class="z-source z-c"><span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> Get/set unaligned access control bits (if meaningful) <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_GET_UNALIGN</span></span><span class="z-meta z-preprocessor z-macro z-c">    <span class="z-constant z-numeric z-integer z-decimal z-c">5</span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_SET_UNALIGN</span></span><span class="z-meta z-preprocessor z-macro z-c">    <span class="z-constant z-numeric z-integer z-decimal z-c">6</span></span>
</span><span class="z-source z-c"><span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> Set/Get process name <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_SET_NAME</span></span><span class="z-meta z-preprocessor z-macro z-c">    <span class="z-constant z-numeric z-integer z-decimal z-c">15</span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_GET_NAME</span></span><span class="z-meta z-preprocessor z-macro z-c">    <span class="z-constant z-numeric z-integer z-decimal z-c">16</span></span>
</span><span class="z-source z-c"><span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> Get/set process endian <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_GET_ENDIAN</span></span><span class="z-meta z-preprocessor z-macro z-c">   <span class="z-constant z-numeric z-integer z-decimal z-c">19</span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_SET_ENDIAN</span></span><span class="z-meta z-preprocessor z-macro z-c">   <span class="z-constant z-numeric z-integer z-decimal z-c">20</span></span>
</span><span class="z-source z-c"><span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> Get/set process seccomp mode <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
</span><span class="z-source z-c"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> -----------------------------------------
</span></span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_GET_SECCOMP</span></span><span class="z-meta z-preprocessor z-macro z-c">  <span class="z-constant z-numeric z-integer z-decimal z-c">21</span>                <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> |</span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_SET_SECCOMP</span></span><span class="z-meta z-preprocessor z-macro z-c">  <span class="z-constant z-numeric z-integer z-decimal z-c">22</span>                <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> |</span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_SET_NO_NEW_PRIVS</span></span><span class="z-meta z-preprocessor z-macro z-c">     <span class="z-constant z-numeric z-integer z-decimal z-c">38</span>        <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> |</span></span>
</span><span class="z-source z-c"><span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">PR_GET_NO_NEW_PRIVS</span></span><span class="z-meta z-preprocessor z-macro z-c">     <span class="z-constant z-numeric z-integer z-decimal z-c">39</span>        <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> |</span></span>
</span><span class="z-source z-c"><span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> -----------------------------------------
</span></span></code></pre><p>In the <code>prctl.h</code>, you can check the values of the macros that go into the first argument, <code>option</code>. Among them, let‚Äôs take a closer look at <code>PR_SET_NO_NEW_PRIVS</code> and <code>PR_SET_SECCOMP</code>, which are related to the SECCOMP.<h3 id=pr-set-no-new-privs><a aria-label="Anchor link for: pr-set-no-new-privs" class="header-anchor no-hover-padding" href=#pr-set-no-new-privs><span aria-hidden=true class=link-icon></span></a> PR_SET_NO_NEW_PRIVS</h3><pre class="language-c z-code" data-lang=c><code class=language-c data-lang=c><span class="z-source z-c"><span class="z-storage z-type z-c">int</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">prctl</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-variable z-parameter z-c">PR_SET_NO_NEW_PRIVS</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">int</span> <span class="z-variable z-parameter z-c">value</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></code></pre><p>The example above sets the <code>no_new_privs</code> property of the current process as <code>value</code>.<p>This property can be checked in the <code>NoNewPrivs</code> field of <code>/proc/&lt;pid>/status</code> since the Linux kernel 4.10. If the value of this property is set to 1, the current process and it‚Äôs child processes cannot execute codes that grant new privileges. However, they can still execute codes that revoke privileges.<p>The importance of this property will be described in the <a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#seccomp-mode-filter>SECCOMP_MODE_FILTER</a> part.<h3 id=pr-set-seccomp><a aria-label="Anchor link for: pr-set-seccomp" class="header-anchor no-hover-padding" href=#pr-set-seccomp><span aria-hidden=true class=link-icon></span></a> PR_SET_SECCOMP</h3><pre class="language-c z-code" data-lang=c><code class=language-c data-lang=c><span class="z-source z-c"><span class="z-storage z-type z-c">int</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">prctl</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-variable z-parameter z-c">PR_SET_SECCOMP</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">int</span> <span class="z-variable z-parameter z-c">mode</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span><span class="z-keyword z-operator z-variadic z-c">...</span><span class="z-punctuation z-section z-brackets z-end z-c">]</span></span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></code></pre><p>Now, we come to the actual control of SECCOMP, which has two modes.<pre class="language-c z-code" data-lang=c><code class=language-c data-lang=c><span class="z-source z-c"> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> Valid values for seccomp.mode and prctl(PR_SET_SECCOMP, &lt;mode>) <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
</span><span class="z-source z-c"> <span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">SECCOMP_MODE_DISABLED</span></span><span class="z-meta z-preprocessor z-macro z-c">   <span class="z-constant z-numeric z-integer z-decimal z-c">0</span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> seccomp is not in use. <span class="z-punctuation z-definition z-comment z-c">*/</span></span></span>
</span><span class="z-source z-c"> <span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">SECCOMP_MODE_STRICT</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> uses hard-coded filter. <span class="z-punctuation z-definition z-comment z-c">*/</span></span></span>
</span><span class="z-source z-c"> <span class="z-meta z-preprocessor z-macro z-c"><span class="z-keyword z-control z-import z-define z-c">#define</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-entity z-name z-constant z-preprocessor z-c">SECCOMP_MODE_FILTER</span></span><span class="z-meta z-preprocessor z-macro z-c"> <span class="z-constant z-numeric z-integer z-decimal z-c">2</span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span> uses user-supplied filter. <span class="z-punctuation z-definition z-comment z-c">*/</span></span></span>
</span></code></pre><p>In the <code>seccomp.h</code>, each mode is defined as a macro.<h4 id=seccomp-mode-strict><a aria-label="Anchor link for: seccomp-mode-strict" class="header-anchor no-hover-padding" href=#seccomp-mode-strict><span aria-hidden=true class=link-icon></span></a> SECCOMP_MODE_STRICT</h4><p>In this mode, only four syscalls are allowed: <code>read</code>, <code>write</code>, <code>exit</code>, and <code>sigreturn</code>. The third argument is not necessary because the available syscalls are already defined.<pre class="language-c z-code" data-lang=c><code class=language-c data-lang=c><span class="z-source z-c"><span class="z-meta z-preprocessor z-include z-c"><span class="z-keyword z-control z-import z-include z-c">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&lt;</span>stdio.h<span class="z-punctuation z-definition z-string z-end z-c">></span></span>
</span></span><span class="z-source z-c"><span class="z-meta z-preprocessor z-include z-c"><span class="z-keyword z-control z-import z-include z-c">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&lt;</span>sys/prctl.h<span class="z-punctuation z-definition z-string z-end z-c">></span></span>
</span></span><span class="z-source z-c"><span class="z-meta z-preprocessor z-include z-c"><span class="z-keyword z-control z-import z-include z-c">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&lt;</span>linux/seccomp.h<span class="z-punctuation z-definition z-string z-end z-c">></span></span>
</span></span><span class="z-source z-c">
</span><span class="z-source z-c"><span class="z-storage z-type z-c">int</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">main</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c"> </span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">        <span class="z-storage z-type z-c">int</span> fd<span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">        <span class="z-storage z-type z-c">char</span> buf<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span><span class="z-constant z-numeric z-integer z-decimal z-c">16</span><span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span><span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-section z-block z-end z-c">}</span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">        <span class="z-keyword z-control z-c">if</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">prctl</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">PR_SET_SECCOMP<span class="z-punctuation z-separator z-c">,</span> SECCOMP_MODE_STRICT</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span> <span class="z-keyword z-operator z-comparison z-c">!=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">                <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">perror</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">"</span>SET_SECCOMP error<span class="z-punctuation z-definition z-string z-end z-c">"</span></span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">        <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">        <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">read</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> buf<span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">16</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">        <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">write</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-separator z-c">,</span> buf</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">        fd <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">open</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">"</span>a.txt<span class="z-punctuation z-definition z-string z-end z-c">"</span></span><span class="z-punctuation z-separator z-c">,</span> <span class="z-string z-quoted z-single z-c"><span class="z-punctuation z-definition z-string z-begin z-c">'</span>w<span class="z-punctuation z-definition z-string z-end z-c">'</span></span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">        <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">write</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">fd<span class="z-punctuation z-separator z-c">,</span> buf</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">        <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">close</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">fd</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">        <span class="z-keyword z-control z-flow z-return z-c">return</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre><p>As a result of compiling and executing the code above, <code>SIGKILL</code> occurred in <code>open</code> like the following.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> ./strict</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">hihi</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">hihi</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[1]</span></span><span class="z-meta z-function-call z-arguments z-shell">    517393 killed     ./strict</span>
</span></code></pre><h4 id=seccomp-mode-filter><a aria-label="Anchor link for: seccomp-mode-filter" class="header-anchor no-hover-padding" href=#seccomp-mode-filter><span aria-hidden=true class=link-icon></span></a> SECCOMP_MODE_FILTER</h4><p>This is a mode that the user builds a rule set to block certain syscalls. The filter mode can be executed only when <code>no_new_privs</code> property is set via the <code>PR_SET_NO_NEW_PRIVS</code>.<p>The rule set is an assembly-like syntax called Berkeley Packet Filter (BPF), which will be covered in detail in the <a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#0x02-seccomp-tools>seccomp-tools</a> section. The following is an example code of filtering out <code>write</code> syscalls.<pre class="language-c z-code" data-lang=c><code class=language-c data-lang=c><span class="z-source z-c"><span class="z-meta z-preprocessor z-include z-c"><span class="z-keyword z-control z-import z-include z-c">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&lt;</span>stdio.h<span class="z-punctuation z-definition z-string z-end z-c">></span></span>
</span></span><span class="z-source z-c"><span class="z-meta z-preprocessor z-include z-c"><span class="z-keyword z-control z-import z-include z-c">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&lt;</span>sys/prctl.h<span class="z-punctuation z-definition z-string z-end z-c">></span></span>
</span></span><span class="z-source z-c"><span class="z-meta z-preprocessor z-include z-c"><span class="z-keyword z-control z-import z-include z-c">#include</span> <span class="z-string z-quoted z-other z-lt-gt z-include z-c"><span class="z-punctuation z-definition z-string z-begin z-c">&lt;</span>linux/seccomp.h<span class="z-punctuation z-definition z-string z-end z-c">></span></span>
</span></span><span class="z-source z-c">
</span><span class="z-source z-c"><span class="z-storage z-modifier z-c">static</span> <span class="z-storage z-type z-c">unsigned</span> <span class="z-storage z-type z-c">char</span> filter<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span><span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
</span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    <span class="z-constant z-numeric z-integer z-decimal z-c">32</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span>    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> A = sys_number
</span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    <span class="z-constant z-numeric z-integer z-decimal z-c">21</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span>    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> if (A == write) goto 0003
</span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    <span class="z-constant z-numeric z-integer z-decimal z-c">6</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">255</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">127</span><span class="z-punctuation z-separator z-c">,</span>    <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> return ALLOW
</span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c">    <span class="z-constant z-numeric z-integer z-decimal z-c">6</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span>        <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> return KILL
</span></span></span><span class="z-source z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span><span class="z-source z-c">
</span><span class="z-source z-c"><span class="z-meta z-struct z-c"><span class="z-storage z-type z-c">struct</span> <span class="z-meta z-struct z-c"><span class="z-entity z-name z-struct z-c">sock_fprog</span></span></span><span class="z-meta z-struct z-c"> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-struct z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-struct z-c"><span class="z-meta z-block z-c">    <span class="z-storage z-type z-c">unsigned</span> <span class="z-storage z-type z-c">short</span> len<span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-struct z-c"><span class="z-meta z-block z-c">    <span class="z-storage z-type z-c">unsigned</span> <span class="z-storage z-type z-c">char</span> <span class="z-keyword z-operator z-c">*</span>filter<span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-struct z-c"><span class="z-meta z-block z-c"></span></span><span class="z-meta z-struct z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span><span class="z-source z-c">
</span><span class="z-source z-c"><span class="z-storage z-type z-c">int</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">main</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c"> </span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-storage z-type z-c">int</span> fd<span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-storage z-type z-c">char</span> buf<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span><span class="z-constant z-numeric z-integer z-decimal z-c">16</span><span class="z-punctuation z-section z-brackets z-end z-c">]</span></span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span><span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-section z-block z-end z-c">}</span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-storage z-type z-c">struct</span> sock_fprog prog<span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-keyword z-control z-c">if</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">prctl</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">PR_SET_NO_NEW_PRIVS<span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span> <span class="z-keyword z-operator z-comparison z-c">!=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">        <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">perror</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">"</span>SET_NO_NEW_PRIVS error<span class="z-punctuation z-definition z-string z-end z-c">"</span></span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    prog<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">len</span> <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-keyword z-operator z-word z-c">sizeof</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span><span class="z-meta z-group z-c">filter</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-keyword z-operator z-arithmetic z-c">/</span> <span class="z-constant z-numeric z-integer z-decimal z-c">8</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    prog<span class="z-punctuation z-accessor z-c">.</span><span class="z-variable z-other z-member z-c">filter</span> <span class="z-keyword z-operator z-assignment z-c">=</span> filter<span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-keyword z-control z-c">if</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">prctl</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">PR_SET_SECCOMP<span class="z-punctuation z-separator z-c">,</span> SECCOMP_MODE_FILTER<span class="z-punctuation z-separator z-c">,</span> <span class="z-keyword z-operator z-c">&</span>prog</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span> <span class="z-keyword z-operator z-comparison z-c">!=</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">        <span class="z-meta z-function-call z-c"><span class="z-support z-function z-C99 z-c">perror</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">"</span>SET_SECCOMP error<span class="z-punctuation z-definition z-string z-end z-c">"</span></span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">read</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-separator z-c">,</span> buf<span class="z-punctuation z-separator z-c">,</span> <span class="z-constant z-numeric z-integer z-decimal z-c">16</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">write</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-constant z-numeric z-integer z-decimal z-c">1</span><span class="z-punctuation z-separator z-c">,</span> buf</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>          <span class="z-comment z-line z-double-slash z-c"><span class="z-punctuation z-definition z-comment z-c">//</span> &lt;----- This will be blocked
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    fd <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">open</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-string z-quoted z-double z-c"><span class="z-punctuation z-definition z-string z-begin z-c">"</span>a.txt<span class="z-punctuation z-definition z-string z-end z-c">"</span></span><span class="z-punctuation z-separator z-c">,</span> <span class="z-string z-quoted z-single z-c"><span class="z-punctuation z-definition z-string z-begin z-c">'</span>w<span class="z-punctuation z-definition z-string z-end z-c">'</span></span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">write</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">fd<span class="z-punctuation z-separator z-c">,</span> buf</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">close</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">fd</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-keyword z-control z-flow z-return z-c">return</span> <span class="z-constant z-numeric z-integer z-decimal z-c">0</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre><p>As a result of compiling and executing the code above, <code>SIGSYS</code> occurred in <code>open</code> like the following.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> ./filter</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">hihi</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">[1]</span></span><span class="z-meta z-function-call z-arguments z-shell">    669145 invalid system call (core dumped</span><span class="z-meta z-function-call z-shell"></span>)  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">./filter</span></span>
</span></code></pre><p>I tried to debug the process because it printed a different message from the <code>SIGKILL</code> message of the strict mode, and I found that the process was terminated by <code>SIGSYS</code> in filter mode.<h2 id=0x02-seccomp-tools><a aria-label="Anchor link for: 0x02-seccomp-tools" class="header-anchor no-hover-padding" href=#0x02-seccomp-tools><span aria-hidden=true class=link-icon></span></a> 0x02. seccomp-tools</h2><p>Looking at the example code of <code>SECCOMP_MODE_FILTER</code>, you need to change the filtering rule into bytecodes and put them in the <code>filter</code> array. However, even if you are an expert, it is difficult to freely convert the desired BPF rule into bytecodes. In this case, seccomp-tools is a good tool to use.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> sudo apt install gcc ruby-dev<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>y</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> gem install seccomp-tools</span>
</span></code></pre><p>You can install seccomp-tools like the above.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> seccomp-tools</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Usage:</span></span><span class="z-meta z-function-call z-arguments z-shell"> seccomp-tools <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>-<span class="z-keyword z-operator z-word z-shell">-</span>version<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span> <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>-<span class="z-keyword z-operator z-word z-shell">-</span>help<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span> <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>command<span class="z-keyword z-operator z-assignment z-redirection z-shell">></span> <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>&lt;options><span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span></span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">List</span></span><span class="z-meta z-function-call z-arguments z-shell"> of commands:</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash">        <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">asm</span></span><span class="z-meta z-function-call z-arguments z-shell">     Seccomp bpf assembler.</span>
</span><span class="z-source z-shell z-bash">        <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">disasm</span></span><span class="z-meta z-function-call z-arguments z-shell">  Disassemble seccomp bpf.</span>
</span><span class="z-source z-shell z-bash">        <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">dump</span></span><span class="z-meta z-function-call z-arguments z-shell">    Automatically dump seccomp bpf from execution file(s</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-meta z-function-call z-shell"><span class="z-support z-function z-dot z-shell">.</span></span>
</span><span class="z-source z-shell z-bash">        <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">emu</span></span><span class="z-meta z-function-call z-arguments z-shell">     Emulate seccomp rules.</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">See</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>seccomp-tools &lt;command> --help<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span> to read about a specific subcommand.</span>
</span></code></pre><p>As you can see in the usage, there are commands like <code>asm</code>, <code>disasm</code>, <code>dump</code>, and <code>emu</code>.<h3 id=asm><a aria-label="Anchor link for: asm" class="header-anchor no-hover-padding" href=#asm><span aria-hidden=true class=link-icon></span></a> asm</h3><p>This command converts BPF rules written like the following to bytecodes.<pre class="language-txt z-code" data-lang=txt><code class=language-txt data-lang=txt><span class="z-text z-plain">A = arch
</span><span class="z-text z-plain">if (A != ARCH_X86_64) goto dead
</span><span class="z-text z-plain">A = sys_number
</span><span class="z-text z-plain">if (A >= 0x40000000) goto dead
</span><span class="z-text z-plain">if (A == write) goto ok
</span><span class="z-text z-plain">if (A == close) goto ok
</span><span class="z-text z-plain">if (A == dup) goto ok
</span><span class="z-text z-plain">if (A == exit) goto ok
</span><span class="z-text z-plain">return ERRNO(5)
</span><span class="z-text z-plain">ok:
</span><span class="z-text z-plain">return ALLOW
</span><span class="z-text z-plain">dead:
</span><span class="z-text z-plain">return KILL
</span></code></pre><p>The variable <code>A</code> appeared out of nowhere, so I wondered what it was at first, but it‚Äôs easier to think of it as just a variable.<p>Now, you can save this content as a file and pass it to the argument of seccomp-tools.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> seccomp-tools asm rule.txt</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span> \x00\x00\x00\x04\x00\x00\x00\x15\x00\x00\b>\x00\x00\xC0 \x00\x00\x00\x00\x00\x00\x005\x00\x06\x00\x00\x00\x00@\x15\x00\x04\x00\x01\x00\x00\x00\x15\x00\x03\x00\x03\x00\x00\x00\x15\x00\x02\x00 \x00\x00\x00\x15\x00\x01\x00&lt;\x00\x00\x00\x06\x00\x00\x00\x05\x00\x05\x00\x06\x00\x00\x00\x00\x00\xFF\x7F\x06\x00\x00\x00\x00\x00\x00\x00<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span></span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> seccomp-tools asm rule.txt<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>f</span> c_array</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">unsigned</span></span><span class="z-meta z-function-call z-arguments z-shell"> char bpf<span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span><span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span> = <span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span>32<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>4<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>21<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>8<span class="z-punctuation z-separator z-shell">,</span>62<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>192<span class="z-punctuation z-separator z-shell">,</span>32<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>53<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>6<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>64<span class="z-punctuation z-separator z-shell">,</span>21<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>4<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>1<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>21<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>3<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>3<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>21<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>2<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>32<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>21<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>1<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>60<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>6<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>5<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>5<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>6<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>255<span class="z-punctuation z-separator z-shell">,</span>127<span class="z-punctuation z-separator z-shell">,</span>6<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> seccomp-tools asm rule.txt<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>f</span> c_source</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell">include &lt;linux/seccomp.h></span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell">include &lt;stdio.h></span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell">include &lt;stdlib.h></span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell">include &lt;sys/prctl.h></span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">static</span></span><span class="z-meta z-function-call z-arguments z-shell"> void install_seccomp(</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-punctuation z-definition z-compound z-braces z-begin z-shell">{</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">static</span></span><span class="z-meta z-function-call z-arguments z-shell"> unsigned char filter<span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span><span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span> = <span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span>32<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>4<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>21<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>8<span class="z-punctuation z-separator z-shell">,</span>62<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>192<span class="z-punctuation z-separator z-shell">,</span>32<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>53<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>6<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>64<span class="z-punctuation z-separator z-shell">,</span>21<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>4<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>1<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>21<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>3<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>3<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>21<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>2<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>32<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>21<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>1<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>60<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>6<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>5<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>5<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>6<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>255<span class="z-punctuation z-separator z-shell">,</span>127<span class="z-punctuation z-separator z-shell">,</span>6<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-separator z-shell">,</span>0<span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">struct</span></span><span class="z-meta z-function-call z-arguments z-shell"> prog <span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">    unsigned short len;
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">    unsigned char <span class="z-keyword z-operator z-regexp z-quantifier z-shell">*</span>filter;
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">  <span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span> rule = <span class="z-meta z-group z-expansion z-brace z-shell"><span class="z-punctuation z-section z-expansion z-brace z-begin z-shell">{</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">    .len = sizeof(filter) >> 3<span class="z-punctuation z-separator z-shell">,</span>
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">    .filter = filter
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-meta z-group z-expansion z-brace z-shell">  <span class="z-punctuation z-section z-expansion z-brace z-end z-shell">}</span></span></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span><span class="z-source z-shell z-bash">  <span class="z-keyword z-control z-conditional z-if z-shell">if</span><span class="z-punctuation z-definition z-compound z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">prctl</span></span><span class="z-meta z-function-call z-arguments z-shell">(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0</span><span class="z-punctuation z-definition z-compound z-end z-shell">)</span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span> <span class="z-constant z-numeric z-integer z-decimal z-file-descriptor z-shell">0</span></span><span class="z-meta z-function-call z-shell"></span>) <span class="z-punctuation z-definition z-compound z-braces z-begin z-shell">{</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">perror</span></span><span class="z-meta z-function-call z-arguments z-shell">(<span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>prctl(PR_SET_NO_NEW_PRIVS)<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span><span class="z-meta z-function-call z-shell"></span>)<span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">exit</span></span><span class="z-meta z-function-call z-arguments z-shell">(2</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-punctuation z-definition z-compound z-braces z-end z-shell">}</span>
</span><span class="z-source z-shell z-bash">  <span class="z-keyword z-control z-conditional z-if z-shell">if</span><span class="z-punctuation z-definition z-compound z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">prctl</span></span><span class="z-meta z-function-call z-arguments z-shell">(PR_SET_SECCOMP, SECCOMP_MODE_FILTER,</span> <span class="z-keyword z-operator z-logical z-job z-shell">&</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">rule</span></span><span class="z-punctuation z-definition z-compound z-end z-shell">)</span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span> <span class="z-constant z-numeric z-integer z-decimal z-file-descriptor z-shell">0</span></span><span class="z-meta z-function-call z-shell"></span>) <span class="z-punctuation z-definition z-compound z-braces z-begin z-shell">{</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">perror</span></span><span class="z-meta z-function-call z-arguments z-shell">(<span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>prctl(PR_SET_SECCOMP)<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span><span class="z-meta z-function-call z-shell"></span>)<span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">exit</span></span><span class="z-meta z-function-call z-arguments z-shell">(2</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-punctuation z-definition z-compound z-braces z-end z-shell">}</span>
</span><span class="z-source z-shell z-bash"><span class="z-punctuation z-definition z-compound z-braces z-end z-shell">}</span>
</span></code></pre><p>As you can see from the example above, you can output the results in various formats. The <code>-f</code> option provides ready-to-use formats such as <code>raw</code>, <code>c_array</code>, <code>c_source</code>, and <code>assembly</code>.<h3 id=disasm><a aria-label="Anchor link for: disasm" class="header-anchor no-hover-padding" href=#disasm><span aria-hidden=true class=link-icon></span></a> disasm</h3><p>The opposite command of <code>asm</code>. It converts BPF in bytecode format to filtering rules. You can give the file where the bytecodes are saved as an input file as an argument.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> xxd rule.raw</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">00000000:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 2000 0000 0400 0000 1500 0008 3e00 00c0   ...........<span class="z-keyword z-operator z-assignment z-redirection z-shell">></span>...</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">00000010:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 2000 0000 0000 0000 3500 0600 0000 0040   .......5......@</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">00000020:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 1500 0400 0100 0000 1500 0300 0300 0000  ................</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">00000030:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 1500 0200 2000 0000 1500 0100 3c00 0000  .... .......<span class="z-keyword z-operator z-assignment z-redirection z-shell">&lt;</span>...</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">00000040:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0600 0000 0500 0500 0600 0000 0000 ff7f  ................</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">00000050:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0600 0000 0000 0000                      ........</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> seccomp-tools disasm rule.raw</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">line</span></span><span class="z-meta z-function-call z-arguments z-shell">  CODE  JT   JF      K</span>
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">================================</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0000:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x20 0x00 0x00 0x00000004  A = arch</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0001:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x00 0x08 0xc000003e  if (A != ARCH_X86_64</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0010</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0002:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x20 0x00 0x00 0x00000000  A = sys_number</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0003:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x35 0x06 0x00 0x40000000  if (A <span class="z-keyword z-operator z-assignment z-redirection z-shell">></span>= 0x40000000</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0010</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0004:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x04 0x00 0x00000001  if (A == write</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0009</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0005:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x03 0x00 0x00000003  if (A == close</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0009</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0006:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x02 0x00 0x00000020  if (A == dup</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0009</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0007:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x01 0x00 0x0000003c  if (A == exit</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0009</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0008:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x06 0x00 0x00 0x00050005  return ERRNO(5</span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0009:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x06 0x00 0x00 0x7fff0000  return ALLOW</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0010:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x06 0x00 0x00 0x00000000  return KILL</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> seccomp-tools asm rule.txt<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>f</span> raw</span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">seccomp-tools</span></span><span class="z-meta z-function-call z-arguments z-shell"> disasm -</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">line</span></span><span class="z-meta z-function-call z-arguments z-shell">  CODE  JT   JF      K</span>
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">================================</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0000:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x20 0x00 0x00 0x00000004  A = arch</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0001:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x00 0x08 0xc000003e  if (A != ARCH_X86_64</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0010</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0002:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x20 0x00 0x00 0x00000000  A = sys_number</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0003:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x35 0x06 0x00 0x40000000  if (A <span class="z-keyword z-operator z-assignment z-redirection z-shell">></span>= 0x40000000</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0010</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0004:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x04 0x00 0x00000001  if (A == write</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0009</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0005:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x03 0x00 0x00000003  if (A == close</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0009</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0006:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x02 0x00 0x00000020  if (A == dup</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0009</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0007:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x01 0x00 0x0000003c  if (A == exit</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0009</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0008:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x06 0x00 0x00 0x00050005  return ERRNO(5</span><span class="z-meta z-function-call z-shell"></span>)
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0009:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x06 0x00 0x00 0x7fff0000  return ALLOW</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0010:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x06 0x00 0x00 0x00000000  return KILL</span>
</span></code></pre><p>By pipelining the <code>asm</code> command, you can check whether the BPF rule is written correctly.<h3 id=dump><a aria-label="Anchor link for: dump" class="header-anchor no-hover-padding" href=#dump><span aria-hidden=true class=link-icon></span></a> dump</h3><p>This is a command that outputs the BPF rules applied within the binary. I looked up how it works out of curiosity, and it seems to analyze the binary dynamically using <code>ptrace</code>.<p>However, since it prints the rules based on the first <code>prctl(PR_SET_SECCOMP)</code>, it may be different from the actual result if the <code>prctl</code> function was called multiple times.<p>In that case, you can increase the number of <code>prctl</code> functions to be checked by giving the <code>-l</code> or <code>--limit</code> option.<p>You can also give the <code>-p</code> or <code>--pid</code> option to check the rules applied to the running process.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> seccomp-tools dump ./filter</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">line</span></span><span class="z-meta z-function-call z-arguments z-shell">  CODE  JT   JF      K</span>
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">================================</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0000:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x20 0x00 0x00 0x00000004  A = arch</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0001:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x00 0x03 0xc000003e  if (A != ARCH_X86_64</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0005</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0002:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x20 0x00 0x00 0x00000000  A = sys_number</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0003:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x01 0x00 0x00000001  if (A == write</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0005</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0004:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x06 0x00 0x00 0x7fff0000  return ALLOW</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0005:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x06 0x00 0x00 0x00000000  return KILL</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> sudo seccomp-tools dump<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">pgrep</span></span><span class="z-meta z-function-call z-arguments z-shell"> filter</span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span></span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">line</span></span><span class="z-meta z-function-call z-arguments z-shell">  CODE  JT   JF      K</span>
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">================================</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0000:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x20 0x00 0x00 0x00000004  A = arch</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0001:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x00 0x03 0xc000003e  if (A != ARCH_X86_64</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0005</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0002:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x20 0x00 0x00 0x00000000  A = sys_number</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0003:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x01 0x00 0x00000001  if (A == write</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0005</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0004:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x06 0x00 0x00 0x7fff0000  return ALLOW</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0005:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x06 0x00 0x00 0x00000000  return KILL</span>
</span></code></pre><p>You can use the <code>dump</code> command like this.<h3 id=emu><a aria-label="Anchor link for: emu" class="header-anchor no-hover-padding" href=#emu><span aria-hidden=true class=link-icon></span></a> emu</h3><p>The <code>emu</code> is a good command to check whether syscalls are properly called or blocked by emulating rule sets. When ran in <code>bash</code>, the output is colored and easy to check.<p><img alt=image src=https://bl4nk.kr/blog/seccomp-using-prctl-function/./image.png><p><img alt=image src=https://bl4nk.kr/blog/seccomp-using-prctl-function/./image-1.png><h2 id=0x03-expected-vulnerability><a aria-label="Anchor link for: 0x03-expected-vulnerability" class="header-anchor no-hover-padding" href=#0x03-expected-vulnerability><span aria-hidden=true class=link-icon></span></a> 0x03. Expected Vulnerability</h2><p>Of course, it depends on how it was coded, but I thought about vulnerabilities that could occur easily.<h3 id=x32-syscall><a aria-label="Anchor link for: x32-syscall" class="header-anchor no-hover-padding" href=#x32-syscall><span aria-hidden=true class=link-icon></span></a> x32 Syscall</h3><p>In the previous example of <code>disasm</code> command in seccomp-tools, there were rules like these.<pre class="language-txt z-code" data-lang=txt><code class=language-txt data-lang=txt><span class="z-text z-plain">0000: 0x20 0x00 0x00 0x00000004  A = arch
</span><span class="z-text z-plain">0001: 0x15 0x00 0x08 0xc000003e  if (A != ARCH_X86_64) goto 0010
</span><span class="z-text z-plain">0002: 0x20 0x00 0x00 0x00000000  A = sys_number
</span><span class="z-text z-plain">0003: 0x35 0x06 0x00 0x40000000  if (A >= 0x40000000) goto 0010
</span></code></pre><p>The <code>0001</code> line is the logic to check if the architecture is <code>X86_64</code>, then why does it check if the <code>sys_number</code> of the <code>0003</code> line is greater than <code>0x40000000</code>?<p>The reason is the compatibility of the <code>X86_64</code> architecture. It was developed for the instructions used in the previous 32-bit to be also used in the 64-bit architecture, and this whole concept is called the x32 ABI. Therefore, 32-bit syscalls can be called in the 64-bit architecture, and the method for doing so is to add <code>0x40000000</code> to the 64-bit syscall number in Linux.<p>Let‚Äôs look at the code of the <code>do_syscall_x32</code> function that is called when a 32-bit syscall is actually called in the Linux kernel.<pre class="language-c z-code" data-lang=c><code class=language-c data-lang=c><span class="z-source z-c"><span class="z-storage z-modifier z-c">static</span> __always_inline <span class="z-storage z-type z-c">bool</span> <span class="z-meta z-function z-c"><span class="z-entity z-name z-function z-c">do_syscall_x32</span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function z-parameters z-c"><span class="z-meta z-group z-c"><span class="z-storage z-type z-c">struct</span> pt_regs <span class="z-keyword z-operator z-c">*</span><span class="z-variable z-parameter z-c">regs</span><span class="z-punctuation z-separator z-c">,</span> <span class="z-storage z-type z-c">int</span> <span class="z-variable z-parameter z-c">nr</span><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-meta z-function z-c">
</span></span><span class="z-source z-c"><span class="z-meta z-function z-c"></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-c">/*</span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-comment z-block z-c">     <span class="z-punctuation z-definition z-comment z-c">*</span> Adjust the starting offset of the table, and convert numbers
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-comment z-block z-c">     <span class="z-punctuation z-definition z-comment z-c">*</span> &lt; __X32_SYSCALL_BIT to very high and thus out of range
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-comment z-block z-c">     <span class="z-punctuation z-definition z-comment z-c">*</span> numbers for comparisons.
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-comment z-block z-c">     <span class="z-punctuation z-definition z-comment z-c">*/</span></span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-storage z-type z-c">unsigned</span> <span class="z-storage z-type z-c">int</span> xnr <span class="z-keyword z-operator z-assignment z-c">=</span> nr <span class="z-keyword z-operator z-arithmetic z-c">-</span> __X32_SYSCALL_BIT<span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-keyword z-control z-c">if</span> <span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span><span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">IS_ENABLED</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">CONFIG_X86_X32_ABI</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span> <span class="z-keyword z-operator z-arithmetic z-c">&&</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">likely</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">xnr <span class="z-keyword z-operator z-comparison z-c">&lt;</span> X32_NR_syscalls</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-section z-group z-end z-c">)</span></span> <span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-begin z-c">{</span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">        xnr <span class="z-keyword z-operator z-assignment z-c">=</span> <span class="z-meta z-function-call z-c"><span class="z-variable z-function z-c">array_index_nospec</span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span></span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c">xnr<span class="z-punctuation z-separator z-c">,</span> X32_NR_syscalls</span></span><span class="z-meta z-function-call z-c"><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-end z-c">)</span></span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">        regs<span class="z-punctuation z-accessor z-c">-></span>ax <span class="z-keyword z-operator z-assignment z-c">=</span> x32_sys_call_table<span class="z-meta z-brackets z-c"><span class="z-punctuation z-section z-brackets z-begin z-c">[</span>xnr<span class="z-punctuation z-section z-brackets z-end z-c">]</span></span><span class="z-meta z-group z-c"><span class="z-punctuation z-section z-group z-begin z-c">(</span>regs<span class="z-punctuation z-section z-group z-end z-c">)</span></span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">        <span class="z-keyword z-control z-flow z-return z-c">return</span> <span class="z-constant z-language z-c">true</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-meta z-block z-c">    <span class="z-punctuation z-section z-block z-end z-c">}</span></span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c">    <span class="z-keyword z-control z-flow z-return z-c">return</span> <span class="z-constant z-language z-c">false</span><span class="z-punctuation z-terminator z-c">;</span>
</span></span></span><span class="z-source z-c"><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"></span></span><span class="z-meta z-function z-c"><span class="z-meta z-block z-c"><span class="z-punctuation z-section z-block z-end z-c">}</span></span></span>
</span></code></pre><p>In the first line of the function, <code>xnr = nr - __X32_SYSCALL_BIT</code> is executed, and the <code>__X32_SYSCALL_BIT</code> value is predefined value <code>0x40000000</code>.<p>Therefore, if there is no logic to verify that the syscall number is less than <code>0x40000000</code> in the BPF rule of a 64-bit binary, even if a specific syscall is blocked, you can still call the syscall of the 32-bit architecture by adding <code>0x40000000</code> to the syscall number using the x32 ABI.<h3 id=filter-overwrite><a aria-label="Anchor link for: filter-overwrite" class="header-anchor no-hover-padding" href=#filter-overwrite><span aria-hidden=true class=link-icon></span></a> Filter Overwrite</h3><p>The simplest idea that comes to mind is that it is a vulnerability that can occur when the BPF filter rule part in memory can be overwritten with a desired value before SECCOMP is set. There are ways to do this, such as changing the rule to allow calling the desired syscall, or overwriting the rule with <code>return ALLOW</code>.<p>There is a related challenge on <a class=external href=https://dreamhack.io>dreamhack.io</a>, which I recommend trying.<h3 id=seccomp-bypass><a aria-label="Anchor link for: seccomp-bypass" class="header-anchor no-hover-padding" href=#seccomp-bypass><span aria-hidden=true class=link-icon></span></a> SECCOMP Bypass</h3><p>I found out while using <code>PR_SET_SECCOMP</code> that if the BPF rule is slightly wrong, the prctl function only returns an error and does not terminate the process.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cat wrong.txt</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">A</span></span><span class="z-meta z-function-call z-arguments z-shell"> = sys_number</span>
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-control z-conditional z-if z-shell">if</span> <span class="z-punctuation z-definition z-compound z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">A</span></span><span class="z-meta z-function-call z-arguments z-shell"> == write</span><span class="z-punctuation z-definition z-compound z-end z-shell">)</span><span class="z-meta z-function-call z-arguments z-shell"> goto 3</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-keyword z-control z-flow z-return z-shell">return</span></span><span class="z-meta z-function-call z-arguments z-shell"> ALLOW</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-keyword z-control z-flow z-return z-shell">return</span></span><span class="z-meta z-function-call z-arguments z-shell"> KILL</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> seccomp-tools asm wrong.txt<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>f</span> raw</span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">seccomp-tools</span></span><span class="z-meta z-function-call z-arguments z-shell"> disasm -</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">line</span></span><span class="z-meta z-function-call z-arguments z-shell">  CODE  JT   JF      K</span>
</span><span class="z-source z-shell z-bash"><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">================================</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0000:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x20 0x00 0x00 0x00000000  A = sys_number</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0001:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x15 0x03 0x00 0x00000001  if (A == write</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">goto</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0005</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0002:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x06 0x00 0x00 0x7fff0000  return ALLOW</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0003:</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x06 0x00 0x00 0x00000000  return KILL</span>
</span></code></pre><p>Here is an example of a wrong BPF rule. If you look closely, you will see that it says goto 0005 on line 0001. When composing <code>wrong.txt</code>, I thoughtlessly set line of <code>goto</code> as 3 where <code>return KILL</code> is located, but I found out that I had to calculate the line as a relative address.<p>For example, if <code>goto 0</code> is on the current line 0001, it is interpreted as going to the next line, 0002; and if it‚Äôs <code>goto 1</code>, it is interpreted as going to the next next line, 0003. So <code>goto 3</code> becomes a command to go to line 0005. Since line 0005 does not exist in <code>wrong.txt</code>, an error occurs when passing it as an option to <code>prctl</code>.<pre class="language-bash z-code" data-lang=bash><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> ./filter</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">SET_SECCOMP</span></span><span class="z-meta z-function-call z-arguments z-shell"> error: Invalid argument</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">hihi</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">hihi</span></span>
</span></code></pre><p>When the wrong rule is applied, a SECCOMP error occurs like this. As a result, the rule that was supposed to block the <code>write</code> syscall was not applied, so the input string was output to <code>STDOUT</code>.<p>Therefore, even if the entire filter cannot be overwritten like <a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#filter-overwrite>Filter Overwrite</a>, if the rule itself can be made nonsensical with a few bytes, an error will occur, but the process will be maintained, so SECCOMP bypass is possible.<h2 id=0x04-references><a aria-label="Anchor link for: 0x04-references" class="header-anchor no-hover-padding" href=#0x04-references><span aria-hidden=true class=link-icon></span></a> 0x04. References</h2><ul><li><a class=external href=https://man7.org/linux/man-pages/man2/prctl.2.html>https://man7.org/linux/man-pages/man2/prctl.2.html</a><li><a class=external href=https://jeongzero.oopy.io/06eebad5-8306-493f-9c6d-e7a04d5aacff>https://jeongzero.oopy.io/06eebad5-8306-493f-9c6d-e7a04d5aacff</a><li><a class=external href=https://velog.io/@woounnan/LINUX-Seccomp>https://velog.io/@woounnan/LINUX-Seccomp</a><li><a class=external href=https://velog.io/@dandb3/SECCOMP2>https://velog.io/@dandb3/SECCOMP2</a><li><a class=external href=https://learn.dreamhack.io/280>https://learn.dreamhack.io/280</a><li><a class=external href=https://github.com/david942j/seccomp-tools>https://github.com/david942j/seccomp-tools</a></ul></section><nav class="full-width article-navigation"><div><a aria-describedby=left_title aria-label=Next href=https://bl4nk.kr/blog/memod/><span class=arrow>‚Üê</span>¬†Next</a><p aria-hidden=true id=left_title>memod</div><div><a aria-describedby=right_title aria-label=Prev href=https://bl4nk.kr/blog/attaching-to-gdb-with-pwntools/>Prev¬†<span class=arrow>‚Üí</span></a><p aria-hidden=true id=right_title>Attaching to gdb with pwntools</div></nav></article></main><div id=button-container><div id=toc-floating-container><input class=toggle id=toc-toggle type=checkbox><label class=overlay for=toc-toggle></label><label title="Toggle Table of Contents" class=button for=toc-toggle id=toc-button><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="M414.82-193.094q-18.044 0-30.497-12.32-12.453-12.319-12.453-30.036t12.453-30.086q12.453-12.37 30.497-12.37h392.767q17.237 0 29.927 12.487 12.69 12.486 12.69 30.203 0 17.716-12.69 29.919t-29.927 12.203H414.82Zm0-244.833q-18.044 0-30.497-12.487Q371.87-462.9 371.87-480.45t12.453-29.92q12.453-12.369 30.497-12.369h392.767q17.237 0 29.927 12.511 12.69 12.512 12.69 29.845 0 17.716-12.69 30.086-12.69 12.37-29.927 12.37H414.82Zm0-245.167q-18.044 0-30.497-12.32t-12.453-30.037q0-17.716 12.453-30.086 12.453-12.369 30.497-12.369h392.767q17.237 0 29.927 12.486 12.69 12.487 12.69 30.203 0 17.717-12.69 29.92-12.69 12.203-29.927 12.203H414.82ZM189.379-156.681q-32.652 0-55.878-22.829t-23.226-55.731q0-32.549 23.15-55.647 23.151-23.097 55.95-23.097 32.799 0 55.313 23.484 22.515 23.484 22.515 56.246 0 32.212-22.861 54.893-22.861 22.681-54.963 22.681Zm0-245.167q-32.652 0-55.878-23.134-23.226-23.135-23.226-55.623 0-32.487 23.467-55.517t56.12-23.03q32.102 0 54.721 23.288 22.62 23.288 22.62 55.775 0 32.488-22.861 55.364-22.861 22.877-54.963 22.877Zm-.82-244.833q-32.224 0-55.254-23.288-23.03-23.289-23.03-55.623 0-32.333 23.271-55.364 23.272-23.03 55.495-23.03 32.224 0 55.193 23.288 22.969 23.289 22.969 55.622 0 32.334-23.21 55.364-23.21 23.031-55.434 23.031Z"/></svg></label><div class=toc-content><div class=toc-container><ul><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#0x00-introduction>0x00. Introduction</a><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#0x01-prctl-function>0x01. prctl function</a> <ul><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#pr-set-no-new-privs>PR_SET_NO_NEW_PRIVS</a><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#pr-set-seccomp>PR_SET_SECCOMP</a> <ul><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#seccomp-mode-strict>SECCOMP_MODE_STRICT</a><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#seccomp-mode-filter>SECCOMP_MODE_FILTER</a></ul></ul><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#0x02-seccomp-tools>0x02. seccomp-tools</a> <ul><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#asm>asm</a><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#disasm>disasm</a><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#dump>dump</a><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#emu>emu</a></ul><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#0x03-expected-vulnerability>0x03. Expected Vulnerability</a> <ul><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#x32-syscall>x32 Syscall</a><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#filter-overwrite>Filter Overwrite</a><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#seccomp-bypass>SECCOMP Bypass</a></ul><li><a href=https://bl4nk.kr/blog/seccomp-using-prctl-function/#0x04-references>0x04. References</a></ul></div></div></div><a title="Go to the top of the page" class=no-hover-padding href=# id=top-button> <svg viewbox="0 0 20 20" fill=currentColor><path d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z"/></svg> </a></div><span class=hidden id=copy-success> Copied! </span><span class=hidden id=copy-init> Copy code to clipboard </span><script defer src=https://bl4nk.kr/js/copyCodeToClipboard.min.js></script></div><footer><section><nav class="socials nav-navs"><ul><li><a class="nav-links no-hover-padding social" href=https://bl4nk.kr/atom.xml> <img alt=feed loading=lazy src=https://bl4nk.kr/social_icons/rss.svg title=feed> </a><li class=js><a class="nav-links no-hover-padding social" data-encoded-email="Ymw0bmtAa29yZWEuYWMua3I=" href=#><img alt=email loading=lazy src=https://bl4nk.kr/social_icons/email.svg title=email> </a><li><a class="nav-links no-hover-padding social" rel=" me" href=https://github.com/fitbl4nk> <img alt=github loading=lazy src=https://bl4nk.kr/social_icons/github.svg title=github> </a></ul></nav><nav class=nav-navs></nav><div class=credits><small> <p><p>~/bl4nk ¬© 2025 bl4nk ‚Ä¢ Unless otherwise noted, the content in this website is available under the <a class=external href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA 4.0</a> license.</p> Powered by <a href=https://www.getzola.org>Zola</a> & <a href=https://github.com/welpo/tabi>tabi</a> ‚Ä¢ <a href=https://github.com/fitbl4nk/bl4nk.kr> Site source </a></small></div></section><script async src=https://bl4nk.kr/js/decodeMail.min.js></script><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><h1 class=visually-hidden id=modalTitle>Search</h1><div id=modal-content><div id=searchBar><div aria-hidden=true class=search-icon><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg></div><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search‚Ä¶ role=combobox spellcheck=false><div class="close-icon interactive-icon" title="Clear search" id=clear-search role=button tabindex=0><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></div></div><div id=results-container><div id=results-info><span id=zero_results> No results</span><span id=one_results> $NUMBER result</span><span id=many_results> $NUMBER results</span><span id=two_results> $NUMBER results</span><span id=few_results> $NUMBER results</span></div><div id=results role=listbox></div></div></div></div></footer>